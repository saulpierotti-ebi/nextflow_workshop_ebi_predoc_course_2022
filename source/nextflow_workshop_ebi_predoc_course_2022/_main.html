<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Nextflow workshop - EBI predoc course 2022</title>
  <meta name="description" content="Nextflow workshop - EBI predoc course 2022" />
  <meta name="generator" content="bookdown #bookdown:version# and GitBook 2.6.7" />

  <meta property="og:title" content="Nextflow workshop - EBI predoc course 2022" />
  <meta property="og:type" content="book" />
  
  
  <meta name="github-repo" content="saulpierotti-ebi/saulpierotti-ebi.github.io" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Nextflow workshop - EBI predoc course 2022" />
  
  
  

<meta name="author" content="Saul Pierotti, PhD student in the Birney group (European Bioinformatics Institute)" />


<meta name="date" content="2022-10-20" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<!--bookdown:link_prev-->
<!--bookdown:link_next-->
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link rel="icon" href="images/favicon.ico">


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  { color: #cccccc; background-color: #303030; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffcfaf; } /* Alert */
code span.an { color: #7f9f7f; font-weight: bold; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #dca3a3; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #f0dfaf; } /* ControlFlow */
code span.ch { color: #dca3a3; } /* Char */
code span.cn { color: #dca3a3; font-weight: bold; } /* Constant */
code span.co { color: #7f9f7f; } /* Comment */
code span.cv { color: #7f9f7f; font-weight: bold; } /* CommentVar */
code span.do { color: #7f9f7f; } /* Documentation */
code span.dt { color: #dfdfbf; } /* DataType */
code span.dv { color: #dcdccc; } /* DecVal */
code span.er { color: #c3bf9f; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #c0bed1; } /* Float */
code span.fu { color: #efef8f; } /* Function */
code span.im { } /* Import */
code span.in { color: #7f9f7f; font-weight: bold; } /* Information */
code span.kw { color: #f0dfaf; } /* Keyword */
code span.op { color: #f0efd0; } /* Operator */
code span.ot { color: #efef8f; } /* Other */
code span.pp { color: #ffcfaf; font-weight: bold; } /* Preprocessor */
code span.sc { color: #dca3a3; } /* SpecialChar */
code span.ss { color: #cc9393; } /* SpecialString */
code span.st { color: #cc9393; } /* String */
code span.va { } /* Variable */
code span.vs { color: #cc9393; } /* VerbatimString */
code span.wa { color: #7f9f7f; font-weight: bold; } /* Warning */
</style>


</head>

<body>



<!--bookdown:title:start-->
<div id="header">
<h1 class="title">Nextflow workshop - EBI predoc course 2022</h1>
<p class="author"><em>Saul Pierotti, PhD student in the Birney group (European Bioinformatics Institute)</em></p>
<p class="date"><em>October 20, 2022</em></p>
</div>
<!--bookdown:title:end-->

<!--bookdown:toc:start-->
  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">
<!--bookdown:toc2:start-->
<ul>
<li><a href="#preface" id="toc-preface">Preface</a></li>
<li><a href="#introduction" id="toc-introduction"><span class="toc-section-number">1</span> Introduction</a>
<ul>
<li><a href="#prerequisites" id="toc-prerequisites"><span class="toc-section-number">1.1</span> Prerequisites</a></li>
<li><a href="#what-is-nextflow" id="toc-what-is-nextflow"><span class="toc-section-number">1.2</span> What is Nextflow?</a></li>
<li><a href="#learning-objectives" id="toc-learning-objectives"><span class="toc-section-number">1.3</span> Learning objectives</a></li>
<li><a href="#setup" id="toc-setup"><span class="toc-section-number">1.4</span> Setup</a></li>
<li><a href="#getting-started" id="toc-getting-started"><span class="toc-section-number">1.5</span> Getting started</a>
<ul>
<li><a href="#general-anatomy-of-a-nextflow-workflow" id="toc-general-anatomy-of-a-nextflow-workflow"><span class="toc-section-number">1.5.1</span> General anatomy of a Nextflow workflow</a></li>
<li><a href="#nextflow-domain-specific-language-versions" id="toc-nextflow-domain-specific-language-versions"><span class="toc-section-number">1.5.2</span> Nextflow domain specific language versions</a></li>
<li><a href="#core-concepts" id="toc-core-concepts"><span class="toc-section-number">1.5.3</span> Core concepts</a></li>
<li><a href="#your-first-workflow" id="toc-your-first-workflow"><span class="toc-section-number">1.5.4</span> Your first workflow</a></li>
</ul></li>
</ul></li>
<li><a href="#basic-features" id="toc-basic-features"><span class="toc-section-number">2</span> Basic features</a>
<ul>
<li><a href="#multiple-processes-and-publication-of-workflow-outputs" id="toc-multiple-processes-and-publication-of-workflow-outputs"><span class="toc-section-number">2.1</span> Multiple processes and publication of workflow outputs</a></li>
<li><a href="#creating-channels-and-specifying-pipeline-parameters" id="toc-creating-channels-and-specifying-pipeline-parameters"><span class="toc-section-number">2.2</span> Creating channels and specifying pipeline parameters</a></li>
<li><a href="#multiple-input-files" id="toc-multiple-input-files"><span class="toc-section-number">2.3</span> Multiple input files</a></li>
<li><a href="#using-a-sample-sheet-and-value-channels" id="toc-using-a-sample-sheet-and-value-channels"><span class="toc-section-number">2.4</span> Using a sample sheet and value channels</a></li>
<li><a href="#software-dependencies" id="toc-software-dependencies"><span class="toc-section-number">2.5</span> Software dependencies</a></li>
<li><a href="#resource-allocation" id="toc-resource-allocation"><span class="toc-section-number">2.6</span> Resource allocation</a></li>
<li><a href="#the-resume-feature" id="toc-the-resume-feature"><span class="toc-section-number">2.7</span> The resume feature</a></li>
<li><a href="#nf-core-pipelines" id="toc-nf-core-pipelines"><span class="toc-section-number">2.8</span> nf-core pipelines</a></li>
<li><a href="#labels" id="toc-labels"><span class="toc-section-number">2.9</span> Labels</a></li>
</ul></li>
<li><a href="#basic-challenge" id="toc-basic-challenge"><span class="toc-section-number">3</span> Basic challenge</a></li>
<li><a href="#advanced-features" id="toc-advanced-features"><span class="toc-section-number">4</span> Advanced features</a>
<ul>
<li><a href="#process-inputs" id="toc-process-inputs"><span class="toc-section-number">4.1</span> Process inputs</a>
<ul>
<li><a href="#input-of-type-val" id="toc-input-of-type-val"><span class="toc-section-number">4.1.1</span> Input of type <code>val</code></a></li>
<li><a href="#input-of-type-path" id="toc-input-of-type-path"><span class="toc-section-number">4.1.2</span> Input of type <code>path</code></a></li>
<li><a href="#input-of-type-tuple" id="toc-input-of-type-tuple"><span class="toc-section-number">4.1.3</span> Input of type <code>tuple</code></a></li>
</ul></li>
<li><a href="#process-outputs" id="toc-process-outputs"><span class="toc-section-number">4.2</span> Process outputs</a></li>
<li><a href="#the-groovy-programming-language" id="toc-the-groovy-programming-language"><span class="toc-section-number">4.3</span> The Groovy programming language</a>
<ul>
<li><a href="#closures" id="toc-closures"><span class="toc-section-number">4.3.1</span> Closures</a></li>
<li><a href="#conditional-statements" id="toc-conditional-statements"><span class="toc-section-number">4.3.2</span> Conditional statements</a></li>
</ul></li>
<li><a href="#channel-factories" id="toc-channel-factories"><span class="toc-section-number">4.4</span> Channel factories</a></li>
<li><a href="#operators" id="toc-operators"><span class="toc-section-number">4.5</span> Operators</a>
<ul>
<li><a href="#the-view-operator" id="toc-the-view-operator"><span class="toc-section-number">4.5.1</span> The <code>view</code> operator</a></li>
<li><a href="#the-map-operator" id="toc-the-map-operator"><span class="toc-section-number">4.5.2</span> The <code>map</code> operator</a></li>
<li><a href="#the-set-operator" id="toc-the-set-operator"><span class="toc-section-number">4.5.3</span> The <code>set</code> operator</a></li>
<li><a href="#the-splitcsv-operator" id="toc-the-splitcsv-operator"><span class="toc-section-number">4.5.4</span> The <code>splitCsv</code> operator</a></li>
<li><a href="#the-flatten-operator" id="toc-the-flatten-operator"><span class="toc-section-number">4.5.5</span> The <code>flatten</code> operator</a></li>
<li><a href="#the-collect-operator" id="toc-the-collect-operator"><span class="toc-section-number">4.5.6</span> The <code>collect</code> operator</a></li>
<li><a href="#the-filter-operator" id="toc-the-filter-operator"><span class="toc-section-number">4.5.7</span> The <code>filter</code> operator</a></li>
<li><a href="#the-first-operator" id="toc-the-first-operator"><span class="toc-section-number">4.5.8</span> The <code>first</code> operator</a></li>
<li><a href="#the-combine-operator" id="toc-the-combine-operator"><span class="toc-section-number">4.5.9</span> The <code>combine</code> operator</a></li>
<li><a href="#the-grouptuple-operator" id="toc-the-grouptuple-operator"><span class="toc-section-number">4.5.10</span> The <code>groupTuple</code> operator</a></li>
</ul></li>
<li><a href="#implicit-variables" id="toc-implicit-variables"><span class="toc-section-number">4.6</span> Implicit variables</a>
<ul>
<li><a href="#script-implicit-variables-available-in-main.nf" id="toc-script-implicit-variables-available-in-main.nf"><span class="toc-section-number">4.6.1</span> Script implicit variables (available in <code>main.nf</code>)</a></li>
<li><a href="#configuration-implicit-variables-available-in-nextflow.config" id="toc-configuration-implicit-variables-available-in-nextflow.config"><span class="toc-section-number">4.6.2</span> Configuration implicit variables (available in <code>nextflow.config</code>)</a></li>
<li><a href="#process-implicit-variables-defined-within-a-process" id="toc-process-implicit-variables-defined-within-a-process"><span class="toc-section-number">4.6.3</span> Process implicit variables (defined within a process)</a></li>
</ul></li>
<li><a href="#directives" id="toc-directives"><span class="toc-section-number">4.7</span> Directives</a>
<ul>
<li><a href="#the-conda-directive" id="toc-the-conda-directive"><span class="toc-section-number">4.7.1</span> The <code>conda</code> directive</a></li>
<li><a href="#the-container-directive" id="toc-the-container-directive"><span class="toc-section-number">4.7.2</span> The <code>container</code> directive</a></li>
<li><a href="#the-cpus-memory-and-time-directives" id="toc-the-cpus-memory-and-time-directives"><span class="toc-section-number">4.7.3</span> The <code>cpus</code>, <code>memory</code>, and <code>time</code> directives</a></li>
<li><a href="#the-label-directive" id="toc-the-label-directive"><span class="toc-section-number">4.7.4</span> The <code>label</code> directive</a></li>
<li><a href="#the-debug-directive" id="toc-the-debug-directive"><span class="toc-section-number">4.7.5</span> The <code>debug</code> directive</a></li>
<li><a href="#the-cache-directive" id="toc-the-cache-directive"><span class="toc-section-number">4.7.6</span> The <code>cache</code> directive</a></li>
<li><a href="#the-errorstrategy-directive" id="toc-the-errorstrategy-directive"><span class="toc-section-number">4.7.7</span> The <code>errorStrategy</code> directive</a></li>
<li><a href="#the-publishdir-directive" id="toc-the-publishdir-directive"><span class="toc-section-number">4.7.8</span> The <code>publishDir</code> directive</a></li>
<li><a href="#the-executor-and-queue-directives" id="toc-the-executor-and-queue-directives"><span class="toc-section-number">4.7.9</span> The <code>executor</code> and <code>queue</code> directives</a></li>
<li><a href="#the-ext-directive" id="toc-the-ext-directive"><span class="toc-section-number">4.7.10</span> The <code>ext</code> directive</a></li>
</ul></li>
<li><a href="#advanced-workflow-configuration" id="toc-advanced-workflow-configuration"><span class="toc-section-number">4.8</span> Advanced workflow configuration</a>
<ul>
<li><a href="#configuration-files-and-command-line-parameters" id="toc-configuration-files-and-command-line-parameters"><span class="toc-section-number">4.8.1</span> Configuration files and command line parameters</a></li>
<li><a href="#configuration-profiles" id="toc-configuration-profiles"><span class="toc-section-number">4.8.2</span> Configuration profiles</a></li>
</ul></li>
<li><a href="#sub-workflows" id="toc-sub-workflows"><span class="toc-section-number">4.9</span> Sub-workflows</a></li>
<li><a href="#nextflow-tower" id="toc-nextflow-tower"><span class="toc-section-number">4.10</span> Nextflow Tower</a></li>
</ul></li>
<li><a href="#advanced-challenge" id="toc-advanced-challenge"><span class="toc-section-number">5</span> Advanced challenge</a>
<ul>
<li><a href="#setup-1" id="toc-setup-1"><span class="toc-section-number">5.1</span> Setup</a></li>
<li><a href="#solution" id="toc-solution"><span class="toc-section-number">5.2</span> Solution</a></li>
</ul></li>
<li><a href="#additional-resources" id="toc-additional-resources">Additional resources</a></li>
<li><a href="#credits" id="toc-credits">Credits</a></li>
</ul>
<!--bookdown:toc2:end-->
      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Nextflow workshop - EBI predoc course 2022</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<!--bookdown:toc:end-->
<!--bookdown:body:start-->
<div id="preface" class="section level1 unnumbered hasAnchor">
<h1 class="unnumbered hasAnchor">Preface<a href="#preface" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This workshop aims at introducing you to the world of workflow managers, in particular the workflow manager Nextflow.
This workshop was written as a practical for the EMBL-EBI predoc course, 2022 cohort.
I hope that you will find it useful, and in any case I would be happy to hear your feedback on it.
You can contact me at <a href="mailto:saul@ebi.ac.uk">saul@ebi.ac.uk</a>.</p>
<p>The workshop is written with an increasing level of difficulty, so feel free to skip what is too easy for you or stop when things become too complex.
The <a href="#introduction">introduction section</a> will help you set up all the software needed to follow this workshop.
The <a href="#basic-features">basic features section</a> will walk you through the fundamental concepts behind workflow managers in general and Nextflow in particular.
The <a href="#advanced-features">advanced features section</a> will explore some more complex features of Nextflow.
The [basic challange][Basic challange] and the [advanced challange][Advanced challange] sections contain challenges for you to solve, at different levels of complexity.</p>
<p>This workshop does not aim at being complete in describing Nextflow functionality.
If this is what you are looking for the best place to explore is the <a href="https://www.nextflow.io/docs/latest/index.html">Nextflow documentation</a>.
My objectives in writing this workshop is to present the features of Nextflow that I consider most important to know, and to present them in a way that shows you how you can use them in real-world scenarios.
As for many topics in coding, there is not a single way for achieving the result that you want.
Here I am showing you my way of writing Nextflow workflows.
Many different approaches would be equally valid, and I encourage you to explore what works best for you and develop your own coding style.</p>
<!--chapter:end:index.Rmd-->
</div>
<div id="introduction" class="section level1 hasAnchor" number="1">
<h1 class="hasAnchor"><span class="header-section-number">1</span> Introduction<a href="#introduction" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="prerequisites" class="section level2 hasAnchor" number="1.1">
<h2 class="hasAnchor"><span class="header-section-number">1.1</span> Prerequisites<a href="#prerequisites" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Familiarity with the Linux shell, as well as basic programming constructs such as for/while loops and if/else statements is assumed.
Familiarity with at least one scripting language such as <a href="https://www.r-project.org/about.html">R</a> or <a href="https://www.python.org/">Python</a> will be beneficial.
A basic knowledge of virtual environments and software containers would be helpful.
Basic knowledge of git beneficial.</p>
</div>
<div id="what-is-nextflow" class="section level2 hasAnchor" number="1.2">
<h2 class="hasAnchor"><span class="header-section-number">1.2</span> What is Nextflow?<a href="#what-is-nextflow" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><a href="https://www.nextflow.io/index.html">Nextflow</a> is an open-source workflow manager consisting of a domain specific language built as a superset of the <a href="https://groovy-lang.org/">Groovy</a> programming language, which is itself a superset of <a href="https://www.java.com/en/">Java</a>.
The purpose of Nextflow is to make it easier to coordinate the execution of complex <a href="https://www.wikiwand.com/en/Pipeline_(computing)">data analysis pipelines</a>, and to facilitate the execution of such pipelines in <a href="https://www.wikiwand.com/en/Cloud_computing">cloud environments</a> and <a href="https://www.hpc.iastate.edu/guides/introduction-to-hpc-clusters/what-is-an-hpc-cluster">high-performance clusters</a>.</p>
<p>In practice, Nextflow allows you to declare how the output of some processes in a pipeline are fed as the input of other processes, leading to the production of a final result.
In addition, Nextflow allows the specification of software requirements for each process using <a href="https://docs.conda.io/en/latest/">conda</a> environments, <a href="https://www.docker.com/">docker</a> containers, and a variety of other solutions.</p>
<p>Once a pipeline has been written in Nextflow, it can be easily scaled from a local laptop to a high-performance cluster or cloud environment without any modification, with Nextflow taking care of environment-specific commands (for example, submitting appropriate jobs to a batch scheduler).
Moreover, the pipeline execution is parallelised if the dependencies among different processes allow it.
A motivation for using a workflow manager such as Nextflow is also to increase the reproducibility of your data analysis.</p>
<p>Finally, each processes in Nextflow is executed in its own unique directory, with automatic staging of the required inputs, so there is no need to think about filename collisions and file locations when developing your pipeline.</p>
<p>Nextflow is developed and maintained by <a href="https://seqera.io/">Seqera Labs</a>. The project was started in Cedric Notredame’s lab at the Centre for Genomic Regulation (<a href="https://www.crg.eu/">CRG</a>) in Barcelona, Spain. Nextflow was conceived with bioinformatics as its key use-case, but it is domain-agnostic and can be used for any data-intensive workflow.</p>
</div>
<div id="learning-objectives" class="section level2 hasAnchor" number="1.3">
<h2 class="hasAnchor"><span class="header-section-number">1.3</span> Learning objectives<a href="#learning-objectives" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>After following this tutorial, the learner will be autonomous in using nextflow for their own data analysis.
They will understand fundamental Nextflow concepts such as processes, workflows, channels, they will be able to write a configuration file to alter the resources allocated for a processes and the software environment of execution, and they will be able to deploy a community-curated pipeline from <a href="https://nf-co.re/">nf-core</a>.</p>
</div>
<div id="setup" class="section level2 hasAnchor" number="1.4">
<h2 class="hasAnchor"><span class="header-section-number">1.4</span> Setup<a href="#setup" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Install <a href="https://github.com/conda-forge/miniforge">mamba</a>, a faster alternative to <a href="https://docs.conda.io/en/latest/">conda</a></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-L</span> <span class="at">-O</span> <span class="st">&quot;https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-</span><span class="va">$(</span><span class="fu">uname</span><span class="va">)</span><span class="st">-</span><span class="va">$(</span><span class="fu">uname</span> <span class="at">-m</span><span class="va">)</span><span class="st">.sh&quot;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bash</span> Mambaforge-<span class="va">$(</span><span class="fu">uname</span><span class="va">)</span>-<span class="va">$(</span><span class="fu">uname</span> <span class="at">-m</span><span class="va">)</span>.sh</span></code></pre></div>
<p>Setup the shell to use mamba</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> init</span></code></pre></div>
<p>Close and re-open your shell.
Then, create a mamba environment for installing Nextflow</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> create <span class="at">-n</span> nextflow nextflow</span></code></pre></div>
<p>Now activate the environment that you just created</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> activate nextflow</span></code></pre></div>
<p>Create an empty git repository in your GitHub account and clone it locally.
I will pretend that this repository is called <code>my_repo</code> in this workshop.
Don’t forget to replace this with the name of your actual repository.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> my_repo</span></code></pre></div>
<p>You can use a text editor of your choice to write Nextflow code.
For example, you may want to use <a href="https://flight-manual.atom.io/getting-started/sections/installing-atom/">Atom</a>.
I recommend to add Nextflow language support to Atom by clicking <a href="atom://settings-view/show-package?package=language-nextflow">here</a>.</p>
<p>Create some essential files that we will be working on inside your new repository</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> main.nf</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> nextflow.config</span></code></pre></div>
</div>
<div id="getting-started" class="section level2 hasAnchor" number="1.5">
<h2 class="hasAnchor"><span class="header-section-number">1.5</span> Getting started<a href="#getting-started" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="general-anatomy-of-a-nextflow-workflow" class="section level3 hasAnchor" number="1.5.1">
<h3 class="hasAnchor"><span class="header-section-number">1.5.1</span> General anatomy of a Nextflow workflow<a href="#general-anatomy-of-a-nextflow-workflow" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A Nextflow workflow is usually represented by a git repository containing all the files describing the workflow logic, configurations, and dependencies.</p>
<p>Text files containing Nextflow code usually have the <code>.nf</code> extension (i.e. <code>my_file.nf</code>).
It does not really matter how you name your files, as long as they contain valid Nextflow code, but for consistency the best practice is to call the file describing the workflow as <code>main.nf</code> and place it at the root of your repository.</p>
<p>The <code>main.nf</code> file can access code from other Nextflow scripts, called sub-workflows, that can have arbitrary names.
The best practice is to place such additional Nextflow scripts under the folder <code>workflows</code> in the root of the repository.
So for example an additional Nextflow script could be named <code>workflows/preprocessing.nf</code>.
We will explore later the usage of sub-workflows, so don’t worry if you don’t understand their purpose yet.</p>
<p>The configurations for the pipeline need to be placed in a file called <code>nextflow.config</code> at the root of the repository.
Note that differently from what was said before regarding <code>main.nf</code>, this name is mandatory for Nextflow to properly recognise the file.
The <code>nextflow.config</code> file can contain for example resource requirements, execution, parameters, and metadata about your workflow.
We will explore more in depth the usage of configurations files in a later section.</p>
<p>Scripts (in any language, for example <a href="https://www.r-project.org/about.html">R</a> or <a href="https://www.python.org/">Python</a>) that are used in the execution of specific processes in your pipeline should be placed in the folder <code>bin</code>.
Scripts placed here are automatically recognise by Nextflow during task execution without the need to specify their full path.</p>
<p>Additional files needed for your workflow, for example a table containing some metadata for your samples, are usually placed under the folder <code>assets</code>.
However this is not required and many workflows do not have an <code>assets</code> folder.</p>
<p>Inputs to the workflow are usually defined in a so-called “sample sheet” that should contain the (preferably) absolute file path to the input files end eventual sample-specific parameters for task execution.
Best practice is to have your sample sheet formatted as a <a href="https://www.wikiwand.com/en/Comma-separated_values">csv</a> file with an appropriate header.
Note that the sample sheet is not part of the pipeline itself.
The absolute path to the sample sheet is usually provided to Nextflow either as a command-line parameter or in the <code>nextflow.config</code> file.</p>
<p>In order to execute your workflow, you would run (do not do it now, we still need to write the workflow) <code>nextflow run main.nf</code> at the root of your repository if your workflow is in a file named <code>main.nf</code>.
This would prompt Nextflow to read the <code>main.nf</code> file and eventual sub-workflows, extract the workflow logic from it, load the configurations in <code>nextflow.config</code>, and coordinate the execution of the different steps in your pipeline to produce the final result.</p>
</div>
<div id="nextflow-domain-specific-language-versions" class="section level3 hasAnchor" number="1.5.2">
<h3 class="hasAnchor"><span class="header-section-number">1.5.2</span> Nextflow domain specific language versions<a href="#nextflow-domain-specific-language-versions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Before starting, it is important to know that Nextflow as it was initially developed is referred to as Domain Specific Language 1 (DSL1).
A major change in the Nextflow syntax was done by its developers, and the new syntax is referred to as DSL 2.
In this workshop we will be using exclusively the new DSL2 syntax.</p>
<p>For this reason, you need to add the following line at the top of your <code>main.nf</code> file:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>nextflow<span class="op">.</span>enable<span class="op">.</span>dsl <span class="op">=</span> <span class="dv">2</span></span></code></pre></div>
<p>So if in the future you will find yourself looking at a Nextflow workflow which is written very differently from what you are used to, it will probably be written according to DSL1 instead of DSL2.</p>
</div>
<div id="core-concepts" class="section level3 hasAnchor" number="1.5.3">
<h3 class="hasAnchor"><span class="header-section-number">1.5.3</span> Core concepts<a href="#core-concepts" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A Nextflow workflow is defined by a set of processes, which execute a single task each, which are coordinate by one or more workflows.
So for example there may be a processes called <code>align_fastq</code> that takes in input a <a href="https://www.wikiwand.com/en/FASTQ_format">fastq</a> file and a <a href="https://www.wikiwand.com/en/Reference_genome">reference genome</a> and uses the software <a href="https://github.com/bwa-mem2/bwa-mem2">bwa-mem2</a> to align it, producing an aligned <a href="https://www.sanger.ac.uk/tool/cram/">cram file</a> in output.</p>
<p>A processes defines as a minimum the command to be executed.
Outputs are typically defined but may be omitted if the process is run for its side effects.
Inputs are usually also defined but there may be processes that do not need any input and instead perform a static computation.
Many additional parameters can be specified for a process, for example the software needed, or how much memory or time is required for its execution.
We will explore processes and their definition more in detail in a later section.</p>
<p>If processes determine what is to be executed and how, workflows instead determine the logic of execution and how different processes communicate with each other.
So for example there may be a workflow called <code>SNP_CALLING</code> that takes a <a href="https://www.wikiwand.com/en/FASTQ_format">fastq</a> file in input, uses the process <code>align_fastq</code> to obtain an aligned <a href="https://www.sanger.ac.uk/tool/cram/">cram file</a>, then gives that cram file in input to another process called <code>gatk_call</code> that uses it to create a <a href="https://www.wikiwand.com/en/Variant_Call_Format">vcf file</a> containing genetic variants.</p>
<p>Processes communicate with each other using so-called “channels”, which are unidirectional <a href="https://www.wikiwand.com/en/FIFO_(computing_and_electronics)">First-In-First-Out (FIFO)</a> queues.
This means that a channel is populated with a set of elements (for example, files) produced by a process in the order in which they are produced.
Then, these elements are consumed one by one by another process in the same order.
Several ways to manipulate, merge, and split channel exist, and we will explore them later.
So for example the workflow that I described above may define an input channel containing the <a href="https://www.wikiwand.com/en/FASTQ_format">fastq</a> files in input, and a channel connecting the output of <code>align_fastq</code> to the input of <code>gatk_call</code>.
Note that channels are unidirectional: communication happens only in one direction, from outputs to inputs.</p>
</div>
<div id="your-first-workflow" class="section level3 hasAnchor" number="1.5.4">
<h3 class="hasAnchor"><span class="header-section-number">1.5.4</span> Your first workflow<a href="#your-first-workflow" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now that you know the basics of what a Nextflow workflow is, we will write a simple workflow and we will execute it.</p>
<p>First of all, open the file <code>main.nf</code> that you created before at the root of your repository in a text editor and add the following to it</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// this is a comment</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>process say_hello <span class="op">{</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// comments can be written anywhere</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;hello_world.txt&quot;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;This is the EBI predoc course&quot; &gt; hello_world.txt</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">say_hello</span><span class="op">()</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    say_hello<span class="op">.</span>out<span class="op">.</span><span class="fu">view</span><span class="op">()</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If you want to see how your <code>main.nf</code> should look like at this stage open this hidden section</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb9"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>nextflow<span class="op">.</span>enable<span class="op">.</span>dsl <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">// this is a comment</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>process say_hello <span class="op">{</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// comments can be written anywhere</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;hello_world.txt&quot;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;This is the EBI predoc course&quot; &gt; hello_world.txt</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">say_hello</span><span class="op">()</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    say_hello<span class="op">.</span>out<span class="op">.</span><span class="fu">view</span><span class="op">()</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</details>
<p>Now open the file <code>nextflow.config</code> and add the following line</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// you can also put comments in nextflow.config</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>workDir <span class="op">=</span> <span class="st">&quot;../nextflow_workdir&quot;</span></span></code></pre></div>
<p>Now run the workflow executing from the root of your repository the following</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nextflow</span> run main.nf</span></code></pre></div>
<p>You should see a bunch of information about your workflow and finally you will see the name of the file we just created, <code>hello_world.txt</code>, appear on your terminal. Note that the full path to the file will be printed in your terminal, which will look something like <code>/home/myname/nextflow_workdir/00/fjdanurew9gihwepw1455idusodhfweioru/hello_world.txt</code>.</p>
<p>Let’s now examine the code step by step:</p>
<ul>
<li>In <code>nextflow.config</code> we declared our working directory to be <code>../nextflow_workdir</code> with the keyword <code>workDir</code>. The working directory is where Nextflow actually stores your files during intermediate processing.</li>
<li>Lines starting with <code>//</code> define a comment in groovy, and they are ignored.</li>
<li>The keyword <code>process</code> defines a process, with the statement that follows defining the process name. So <code>process say_hello</code> creates a process named <code>say_hello</code>.</li>
<li>Curly braces enclose a block of code, so <code>process say_hello {&lt;some code&gt;}</code> is understood by Nextflow as defining <code>&lt;some code&gt;</code> to belong to the process named <code>say_hello</code>.</li>
<li>The keyword <code>output:</code> when used inside of a process defines the expected outputs that that process should produce. If the declared output is absent at the end of the process’ execution the execution fails.</li>
<li>Several types of outputs can be defined, and <code>path</code> is one of them. The keyword <code>path</code> defines what comes after it to be a file.</li>
<li>Output files are named in the output block after the <code>path</code> qualifier. They should be placed inside a string. Strings are enclosed in quotes in groovy (<code>"this is a string"</code>).</li>
<li>The <code>script:</code> keyword defines the actual command to be executed in the process. The command should be provided as a string. Since commands can be long, here a multi-line string is used. In groovy, multi-line strings are enclosed in three quotes</li>
</ul>
<pre><code>&quot;&quot;&quot;
this is a multi-line string
it is very long
&quot;&quot;&quot;</code></pre>
<ul>
<li>What is declared in the <code>script:</code> block is executed in the shell by default, so we should write <a href="https://www.wikiwand.com/en/Bash_(Unix_shell)">bash</a> code there
<ul>
<li>The command that we wrote, <code>echo "This is the EBI predoc course" &gt; hello_world.txt</code>, creates a file called <code>hello_world.txt</code> containing the string <code>"This is the EBI predoc course"</code></li>
</ul></li>
<li>The keyword <code>workflow</code> defines a workflow, that we left unnamed in this case. The last workflow to be written in your <code>main.nf</code> file is automatically executed by Nextflow.
<ul>
<li>The workflow that we defined executes the process <code>say_hello</code></li>
<li>The output of the process <code>say_hello</code> is captured by <code>say_hello.out</code>, which is a channel. In this case it will contain just the file <code>hello_world.txt</code></li>
<li>The operator <code>view()</code> just echoes to the terminal the content of the channel. In this case it prints <code>hello_world.txt</code> to our shell.</li>
</ul></li>
</ul>
<p>So to put everything together, when you ran <code>nextflow run main.nf</code> Nextflow read the <code>main.nf</code> file, it found the last workflow, which we left unnamed, and executed it.
Some additional notes:</p>
<ul>
<li>It is possible to write <code>path("a_file.txt")</code> or <code>path "a_file.txt"</code>, they are equivalent statements</li>
<li>There is no need to think about where we are creating our files, Nextflow under the hood creates a private directory for each execution and takes care of moving files around as needed by other processes</li>
<li>It is common practice to chain different operators on a channel</li>
<li>It is possible to chain operators on separate lines
<ul>
<li>The following is equivalent to <code>say_hello.out.view()</code></li>
</ul>
<pre><code>say_hello.out
  .view()</code></pre></li>
<li>Note that spaces and <a href="https://www.wikiwand.com/en/Tab_key">tab charachters</a> are just for visual clarity and are not required</li>
<li>Explore the working directory <code>../nextflow_workdir</code>. It contains a directory with a strange alphanumeric name like <code>00/fjdanurew9gihwepw1455idusodhfweioru</code> (NOTE: yours will have a different name). One different directory like this is created by Nextflow for the execution of each task (a task is an instance of a process, a process is the definition itself, while a task is created each time that process is executed on different inputs).
<ul>
<li>Inside the directory with the strange name, you will see the file that we just created, <code>hello_world.txt</code></li>
<li>Read the content of the file with <code>cat hello_world.txt</code>. You should see <code>This is the EBI predoc course</code> in your terminal.</li>
</ul></li>
</ul>
<!--chapter:end:01-intro.Rmd-->
</div>
</div>
</div>
<div id="basic-features" class="section level1 hasAnchor" number="2">
<h1 class="hasAnchor"><span class="header-section-number">2</span> Basic features<a href="#basic-features" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="multiple-processes-and-publication-of-workflow-outputs" class="section level2 hasAnchor" number="2.1">
<h2 class="hasAnchor"><span class="header-section-number">2.1</span> Multiple processes and publication of workflow outputs<a href="#multiple-processes-and-publication-of-workflow-outputs" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s now step up a bit the complexity and write a workflow containing two processes that communicate with each other.
Add the following process to your <code>main.nf</code> file.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>process duplicate_lines <span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    publishDir <span class="st">&quot;../nextflow_output/duplicate_lines&quot;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        path my_file</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;</span><span class="ss">${</span>my_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.duplicated.txt&quot;</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="st">        cat </span><span class="ss">$my_file</span><span class="st"> </span><span class="ss">$my_file</span><span class="st"> &gt; </span><span class="ss">${</span>my_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.duplicated.txt</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>And modify your workflow block as follows</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">say_hello</span><span class="op">()</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">duplicate_lines</span><span class="op">(</span> say_hello<span class="op">.</span>out <span class="op">)</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If you want to see how your <code>main.nf</code> should look like at this stage open this hidden section</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb16"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>nextflow<span class="op">.</span>enable<span class="op">.</span>dsl <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">// this is a comment</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>process say_hello <span class="op">{</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// comments can be written anywhere</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;hello_world.txt&quot;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;This is the EBI predoc course&quot; &gt; hello_world.txt</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>process duplicate_lines <span class="op">{</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    publishDir <span class="st">&quot;../nextflow_output/duplicate_lines&quot;</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>        path my_file</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;</span><span class="ss">${</span>my_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.duplicated.txt&quot;</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="st">        cat </span><span class="ss">$my_file</span><span class="st"> </span><span class="ss">$my_file</span><span class="st"> &gt; </span><span class="ss">${</span>my_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.duplicated.txt</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">say_hello</span><span class="op">()</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">duplicate_lines</span><span class="op">(</span> say_hello<span class="op">.</span>out <span class="op">)</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</details>
<p>Now run again the workflow with <code>nextflow run main.nf</code>.
This time your workflow will not print anything since we omitted the <code>view()</code> operator.
However, if you type in your terminal the following</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ../nextflow_output/duplicate_lines/hello_world.duplicated.txt</span></code></pre></div>
<p>You should see the following</p>
<pre><code>This is the EBI predoc course
This is the EBI predoc course</code></pre>
<p>So as you see, the content of the <code>hello_world.txt</code> file that we created before has been duplicated so that it appears twice and it has been placed on a new file, <code>../nextflow_output/duplicate_lines/hello_world.duplicated.txt</code>.</p>
<p>Let’s analyse what happened this time:</p>
<ul>
<li>We created another process called <code>duplicate_lines</code> which duplicates a given file thanks to its <code>script</code> command <code>cat $my_file $my_file &gt; ${my_file.simpleName}.duplicated.txt</code></li>
<li><code>duplicate_lines</code> declares an <code>input:</code> block. The input block is similar to the output block that we saw before in that it can use the <code>path</code> qualifier to declare the input to be a file. However, what comes after <code>path</code> does not need to be a real filename, it is just a variable name (note that it is not quoted). Nextflow replaces that variable with the real name of the file given in input.</li>
<li>In the script and output blocks we can refer to the inputs by specifying <code>$my_file</code>. Note that we need to use the same name used in the input declaration.
<ul>
<li>It is possible to enclose the variable name in curly braces to demark it from other text. So <code>${my_file}</code> is equivalent to <code>$my_file</code>.</li>
<li>We applied the operator <code>simpleName</code> to the variable <code>$my_file</code> by writing <code>${my_file.simpleName}</code>. This removes the path and the extension from <code>my_file</code>, so that we can use it to name our output file (if <code>$my_file</code> contains the value <code>"/some/path/hello_world.txt"</code>, then <code>${my_file.simpleName}</code> contains only <code>hello_world</code>).</li>
</ul></li>
<li>We used a new directive in the process <code>duplicate_lines</code>, called <code>publishDir</code>. This specifies the folder where the output of the process should be placed at the end of the execution. This is usually done to put the final outputs of your workflow in a meaningful directory structure. In our case, <code>publishDir "../nextflow_output/duplicate_lines"</code> places <code>${my_file.simpleName}.duplicated.txt</code> in the folder <code>../nextflow_output/duplicate_lines</code></li>
<li>In the workflow block we called the process <code>duplicate_lines</code> with <code>say_hello.out</code> as an argument. So the output of <code>say_hello</code> is used as an input for <code>duplicate_lines</code>. Note that the number of arguments provided to a process must match the number of arguments declared in its input block.</li>
</ul>
</div>
<div id="creating-channels-and-specifying-pipeline-parameters" class="section level2 hasAnchor" number="2.2">
<h2 class="hasAnchor"><span class="header-section-number">2.2</span> Creating channels and specifying pipeline parameters<a href="#creating-channels-and-specifying-pipeline-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The workflow that we wrote works as expected but it is not very useful since we cannot specify dynamically its input files. We will now learn how to use pipeline parameters to specify an external input file for the whole workflow and how to use channel factories to feed it to our processes.</p>
<p>First create a text file called <code>../nextflow_inputs/a_file.txt</code> containing the string <code>"This is the file content"</code></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> ../nextflow_inputs</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;This is the file content&quot;</span> <span class="op">&gt;</span> ../nextflow_inputs/a_file.txt</span></code></pre></div>
<p>Modify the workflow as follows</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Channel</span><span class="op">.</span><span class="fu">fromPath</span><span class="op">(</span> params<span class="op">.</span>input_file <span class="op">).</span><span class="fu">set</span><span class="op">{</span> input_ch <span class="op">}</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">duplicate_lines</span><span class="op">(</span> input_ch <span class="op">)</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If you want to see how your <code>main.nf</code> should look like at this stage open this hidden section</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb21"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>nextflow<span class="op">.</span>enable<span class="op">.</span>dsl <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">// this is a comment</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>process say_hello <span class="op">{</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// comments can be written anywhere</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;hello_world.txt&quot;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;This is the EBI predoc course&quot; &gt; hello_world.txt</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>process duplicate_lines <span class="op">{</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    publishDir <span class="st">&quot;../nextflow_output/duplicate_lines&quot;</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>        path my_file</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;</span><span class="ss">${</span>my_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.duplicated.txt&quot;</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="st">        cat </span><span class="ss">$my_file</span><span class="st"> </span><span class="ss">$my_file</span><span class="st"> &gt; </span><span class="ss">${</span>my_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.duplicated.txt</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Channel</span><span class="op">.</span><span class="fu">fromPath</span><span class="op">(</span> params<span class="op">.</span>input_file <span class="op">).</span><span class="fu">set</span><span class="op">{</span> input_ch <span class="op">}</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">duplicate_lines</span><span class="op">(</span> input_ch <span class="op">)</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</details>
<p>Now open the file <code>nextflow.config</code> and add the following</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>params <span class="op">{</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  input_file <span class="op">=</span> <span class="st">&quot;../nextflow_inputs/a_file.txt&quot;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If you want to see how your <code>nextflow.config</code> should look like at this stage open this hidden section</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb23"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">// you can also put comments in nextflow.config</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>workDir <span class="op">=</span> <span class="st">&quot;../nextflow_workdir&quot;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>params <span class="op">{</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  input_file <span class="op">=</span> <span class="st">&quot;../nextflow_inputs/a_file.txt&quot;</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</details>
<p>Now run again the workflow with <code>nextflow run main.nf</code>.
This time if you examine the folder <code>../nextflow_output/duplicate_lines</code> you will find a file called <code>a_file.duplicated.txt</code>. Let’s see it’s content.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ../nextflow_output/duplicate_lines/a_file.duplicated.txt</span></code></pre></div>
<p>This should print</p>
<pre><code>This is the file content
This is the file content</code></pre>
<p>So the content of the file that we created before, <code>a_file.txt</code> was duplicated and placed in the file <code>a_file.duplicated.txt</code> in the folder <code>../nextflow_output/duplicate_lines</code>.
Let’s examine what happened:</p>
<ul>
<li>In <code>nextflow.config</code>, we declared a <code>params</code> block. Any variable written inside this block, like <code>input_file = "../nextflow_inputs/a_file.txt"</code>, is accessible in the workflow by writing <code>params.&lt;variable_name&gt;</code>, so <code>params.input_file</code> in this case.</li>
<li>In <code>main.nf</code>, we wrote <code>Channel.fromPath( params.input_file )</code>. This uses the channel factory <code>Channel.fromPath</code> to create a new channel using the content of <code>params.input_file</code>. The <code>Channel.fromPath</code> factory interprets its argument to be the path to a file.</li>
<li>After <code>Channel.fromPath( params.input_file )</code> we added <code>set{ input_ch }</code> (note the curly braces: it is a <a href="https://www.wikiwand.com/en/Closure_(computer_programming)">closure</a>, we will explore later what does it mean). This assigns to the newly created channel the name <code>input_ch</code></li>
<li>We then used the channel <code>input_ch</code> as an input for the process <code>duplicate_lines</code> in the statement <code>duplicate_lines( input_ch )</code>. Since the channel <code>input_ch</code> contains the variable <code>params.input_file</code>, which we declared to contain the value <code>../nextflow_inputs/a_file.txt</code>, this file is given in input to <code>duplicate_lines</code></li>
<li><code>duplicate_lines</code> performed its function as before, putting its output in <code>../nextflow_output/duplicate_lines</code></li>
</ul>
<p>Instead than hard-coding parameters in <code>nextflow.config</code>, it is also possible to pass them on the command line. So for example we could have omitted the <code>params</code> block in <code>nextflow.config</code> and run</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nextflow</span> run main.nf <span class="at">--input_file</span> ../nextflow_inputs/a_file.txt</span></code></pre></div>
<p>This produces the same result. Note that pipeline parameters need to be specified with two prepending dashes (<code>--my_parameter</code>).
This differentiates them from command line options for Nextflow itself, such as <code>-dry-run</code>, which use a single dash.</p>
</div>
<div id="multiple-input-files" class="section level2 hasAnchor" number="2.3">
<h2 class="hasAnchor"><span class="header-section-number">2.3</span> Multiple input files<a href="#multiple-input-files" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We are now able to process a single file with our pipeline, but what if we have many files that we need to process in the same way?
One approach for this is to use a <a href="https://www.wikiwand.com/en/Glob_(programming)">glob pattern</a> as an input.</p>
<p>Let’s create a bunch of files to use in input</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;This is content of file 1&quot;</span> <span class="op">&gt;</span> ../nextflow_inputs/set_of_files_1.txt</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;This is content of file 2&quot;</span> <span class="op">&gt;</span> ../nextflow_inputs/set_of_files_2.txt</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;This is content of file 3&quot;</span> <span class="op">&gt;</span> ../nextflow_inputs/set_of_files_3.txt</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;This is content of file 4&quot;</span> <span class="op">&gt;</span> ../nextflow_inputs/set_of_files_4.txt</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;This is content of file 5&quot;</span> <span class="op">&gt;</span> ../nextflow_inputs/set_of_files_5.txt</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;This is content of file 6&quot;</span> <span class="op">&gt;</span> ../nextflow_inputs/set_of_files_6.txt</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;This is content of file 7&quot;</span> <span class="op">&gt;</span> ../nextflow_inputs/set_of_files_7.txt</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;This is content of file 8&quot;</span> <span class="op">&gt;</span> ../nextflow_inputs/set_of_files_8.txt</span></code></pre></div>
<p>Now we just need to modify <code>input_file</code> in <code>nextflow.config</code></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>params <span class="op">{</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  input_file <span class="op">=</span> <span class="st">&quot;../nextflow_inputs/set_of_files_*.txt&quot;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If you want to see how your <code>nextflow.config</code> should look like at this stage open this hidden section</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb29"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">// you can also put comments in nextflow.config</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>workDir <span class="op">=</span> <span class="st">&quot;../nextflow_workdir&quot;</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>params <span class="op">{</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  input_file <span class="op">=</span> <span class="st">&quot;../nextflow_inputs/set_of_files_*.txt&quot;</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</details>
<p>Now run again the workflow with <code>nextflow run main.nf</code>.
This time if you examine the output folder with <code>ls ../nextflow_output/duplicate_lines</code> you will find a set of files</p>
<pre><code>a_file.duplicated.txt
set_of_files_1.duplicated.txt
set_of_files_2.duplicated.txt
set_of_files_3.duplicated.txt
set_of_files_4.duplicated.txt
set_of_files_5.duplicated.txt
set_of_files_6.duplicated.txt
set_of_files_7.duplicated.txt
set_of_files_8.duplicated.txt</code></pre>
<p>Like before, each of them will contain the duplicated version of the original files.</p>
<p>Let’s examine what happened:</p>
<ul>
<li>We changed <code>params.input_ch</code> to contain a glob pattern. This is expanded by Nextflow to yield a list of matching files.</li>
<li>The matching files are fed one by one via the channel <code>input_ch</code> to the process <code>duplicate_lines</code></li>
<li><code>duplicate_lines</code> operates independently but in parallel on all the inputs, producing the output files. Each task is executed in its own private directory.</li>
</ul>
</div>
<div id="using-a-sample-sheet-and-value-channels" class="section level2 hasAnchor" number="2.4">
<h2 class="hasAnchor"><span class="header-section-number">2.4</span> Using a sample sheet and value channels<a href="#using-a-sample-sheet-and-value-channels" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Using glob patterns for specifying samples is useful and quick, but what if we want to specify input files that live in many different directories with very different names?
And if we want some files to be processed in pairs with other specific files, or with specific parameters?
For such use cases a sample sheet is the easiest solution and it is the recommended way to specify workflow inputs.</p>
<p>A sample sheet is just a <a href="https://www.wikiwand.com/en/Comma-separated_values">csv</a> file with one row per file to be processed, and with each column specifying either a file or a parameter.
Create a sample sheet called <code>../nextflow_inputs/samplesheet.csv</code> by running the following command.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;sample,content&quot;</span> <span class="op">&gt;</span> ../nextflow_inputs/samplesheet.csv</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span><span class="st">/../nextflow_inputs/set_of_files_1.txt,csv_content_1&quot;</span> <span class="op">&gt;&gt;</span> ../nextflow_inputs/samplesheet.csv</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span><span class="st">/../nextflow_inputs/set_of_files_2.txt,csv_content_2&quot;</span> <span class="op">&gt;&gt;</span> ../nextflow_inputs/samplesheet.csv</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span><span class="st">/../nextflow_inputs/set_of_files_3.txt,csv_content_3&quot;</span> <span class="op">&gt;&gt;</span> ../nextflow_inputs/samplesheet.csv</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span><span class="st">/../nextflow_inputs/set_of_files_4.txt,csv_content_4&quot;</span> <span class="op">&gt;&gt;</span> ../nextflow_inputs/samplesheet.csv</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span><span class="st">/../nextflow_inputs/set_of_files_5.txt,csv_content_5&quot;</span> <span class="op">&gt;&gt;</span> ../nextflow_inputs/samplesheet.csv</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span><span class="st">/../nextflow_inputs/set_of_files_6.txt,csv_content_6&quot;</span> <span class="op">&gt;&gt;</span> ../nextflow_inputs/samplesheet.csv</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span><span class="st">/../nextflow_inputs/set_of_files_7.txt,csv_content_7&quot;</span> <span class="op">&gt;&gt;</span> ../nextflow_inputs/samplesheet.csv</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span><span class="st">/../nextflow_inputs/set_of_files_8.txt,csv_content_8&quot;</span> <span class="op">&gt;&gt;</span> ../nextflow_inputs/samplesheet.csv</span></code></pre></div>
<p>Now create a process called <code>append_to_file</code></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>process append_to_file <span class="op">{</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    publishDir <span class="st">&quot;../nextflow_output/append_to_file&quot;</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>        path my_file</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>        val my_val</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;</span><span class="ss">${</span>my_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.appended.txt&quot;</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="st">        cat </span><span class="ss">$my_file</span><span class="st"> &gt; </span><span class="ss">${</span>my_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.appended.txt</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;</span><span class="ss">$my_val</span><span class="st">&quot; &gt;&gt; </span><span class="ss">${</span>my_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.appended.txt</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>And modify the workflow as follows</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Channel</span><span class="op">.</span><span class="fu">fromPath</span><span class="op">(</span> params<span class="op">.</span>samplesheet <span class="op">)</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">splitCsv</span><span class="op">(</span> header<span class="op">:</span> <span class="kw">true</span> <span class="op">)</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">set</span><span class="op">{</span> input_ch <span class="op">}</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    input_ch<span class="op">.</span><span class="fu">map</span><span class="op">{</span> it<span class="op">[</span><span class="st">&quot;sample&quot;</span><span class="op">]</span> <span class="op">}.</span><span class="fu">set</span><span class="op">{</span> sample_ch <span class="op">}</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    input_ch<span class="op">.</span><span class="fu">map</span><span class="op">{</span> it<span class="op">[</span><span class="st">&quot;content&quot;</span><span class="op">]</span> <span class="op">}.</span><span class="fu">set</span><span class="op">{</span> content_ch <span class="op">}</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">duplicate_lines</span><span class="op">(</span> sample_ch <span class="op">)</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">append_to_file</span><span class="op">(</span> duplicate_lines<span class="op">.</span>out<span class="op">,</span> content_ch <span class="op">)</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If you want to see how your <code>main.nf</code> file should look like at this stage open this hidden section</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb34"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>nextflow<span class="op">.</span>enable<span class="op">.</span>dsl <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co">// this is a comment</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>process say_hello <span class="op">{</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// comments can be written anywhere</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;hello_world.txt&quot;</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;This is the EBI predoc course&quot; &gt; hello_world.txt</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>process duplicate_lines <span class="op">{</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    publishDir <span class="st">&quot;../nextflow_output/duplicate_lines&quot;</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>        path my_file</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;</span><span class="ss">${</span>my_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.appended.txt&quot;</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="st">        cat </span><span class="ss">$my_file</span><span class="st"> </span><span class="ss">$my_file</span><span class="st"> &gt; </span><span class="ss">${</span>my_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.duplicated.txt</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>process append_to_file <span class="op">{</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    publishDir <span class="st">&quot;../nextflow_output/append_to_file&quot;</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>        path my_file</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>        val my_val</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;</span><span class="ss">${</span>my_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.duplicated.txt&quot;</span></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a><span class="st">        cat </span><span class="ss">$my_file</span><span class="st"> &gt; </span><span class="ss">${</span>my_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.appended.txt</span></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;</span><span class="ss">$my_val</span><span class="st">&quot; &gt;&gt; </span><span class="ss">${</span>my_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.appended.txt</span></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Channel</span><span class="op">.</span><span class="fu">fromPath</span><span class="op">(</span> params<span class="op">.</span>samplesheet <span class="op">)</span></span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">splitCsv</span><span class="op">(</span> header<span class="op">:</span> <span class="kw">true</span> <span class="op">)</span></span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">set</span><span class="op">{</span> input_ch <span class="op">}</span></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>    input_ch<span class="op">.</span><span class="fu">map</span><span class="op">{</span> it<span class="op">[</span><span class="st">&quot;sample&quot;</span><span class="op">]</span> <span class="op">}.</span><span class="fu">set</span><span class="op">{</span> sample_ch <span class="op">}</span></span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>    input_ch<span class="op">.</span><span class="fu">map</span><span class="op">{</span> it<span class="op">[</span><span class="st">&quot;content&quot;</span><span class="op">]</span> <span class="op">}.</span><span class="fu">set</span><span class="op">{</span> content_ch <span class="op">}</span></span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">duplicate_lines</span><span class="op">(</span> sample_ch <span class="op">)</span></span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">append_to_file</span><span class="op">(</span> duplicate_lines<span class="op">.</span>out<span class="op">,</span> content_ch <span class="op">)</span></span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</details>
<p>Now we need to modify the <code>params</code> block in your <code>nextflow.config</code></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>params <span class="op">{</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  samplesheet <span class="op">=</span> <span class="st">&quot;../nextflow_inputs/samplesheet.csv&quot;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If you want to see how your <code>nextflow.config</code> should look like at this stage open this hidden section</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb36"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">// you can also put comments in nextflow.config</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>workDir <span class="op">=</span> <span class="st">&quot;../nextflow_workdir&quot;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>params <span class="op">{</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  samplesheet <span class="op">=</span> <span class="st">&quot;../nextflow_inputs/samplesheet.csv&quot;</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</details>
<p>Now run again the workflow with <code>nextflow run main.nf</code>.
This time if you examine the output folder with <code>ls ../nextflow_output/append_to_file</code> you will find a set of files</p>
<pre><code>set_of_files_1.append_to_file.txt
set_of_files_2.append_to_file.txt
set_of_files_3.append_to_file.txt
set_of_files_4.append_to_file.txt
set_of_files_5.append_to_file.txt
set_of_files_6.append_to_file.txt
set_of_files_7.append_to_file.txt
set_of_files_8.append_to_file.txt</code></pre>
<p>Taking as an example the first one, <code>set_of_files_1.append_to_file.txt</code> we would expect it to contain</p>
<pre><code>This is content of file 1
This is content of file 1
csv_content_1</code></pre>
<p>However, most probably it will contain something like</p>
<pre><code>This is content of file 1
This is content of file 1
csv_content_3</code></pre>
<p>So the first two lines have the correct number but the last line shows the wrong element! What’s more, the element shown on the last line can be different on each run (try!). We said before that channels are guaranteed to emit elements in the same order that they are received, so we should have the correct matches between files and values. What happened?</p>
<p>What happened is that while channels are indeed guaranteed to preserve order, processes and some operators are not because of their asynchronous and parallel nature. In our case, the process <code>duplicate_lines</code> receives the files in the correct order, but it is not guaranteed to emit them in the same order. This is because all the file are processed in parallel, and for example <code>set_of_files_5.append_to_file.txt</code> could be processed and emitted some milliseconds earlier that <code>set_of_files_1.append_to_file.txt</code>, and so the order would be altered.</p>
<p>A better approach when we want multiple channels to be used by one process with some predictable matching is to join channels using matching keys. We will explore it in a later section.
For now, let’s examine what happened in this version of our workflow:</p>
<ul>
<li>We created the process <code>append_to_file</code>, which takes in input a file (<code>path my_file</code>) and a value (<code>val my_val</code>). This process copies the content of <code>my_file</code> to <code>${my_file.simpleName}.append_to_file.txt</code> and then appends to the newly created file the content of <code>my_val</code></li>
<li>We defined the parameter <code>samplesheet</code> in <code>nextflow.config</code></li>
<li>We modified the workflow so that we use <code>params.samplesheet</code> to create a channel with <code>Channel.fromPath</code></li>
<li>We applied the operator <code>splitCsv</code> to this channel containing the samplesheet, using the option <code>header: true</code>. This operator reads the file contained in the channel assuming it to be a csv file with an header line. Then it produces in output another channel containing, for each row in the samplesheet, a groovy map (what in Python would be called a <a href="https://en.wikibooks.org/wiki/A-level_Computing/AQA/Paper_1/Fundamentals_of_data_structures/Dictionaries">dictionary</a>). This map contains a key for each element in the csv header, and a value corresponding to the value of that column in the current line of the csv file.</li>
<li>We apply the <code>map</code> operator (<code>.map{ it["sample"] }</code>) to the resulting channel
<ul>
<li>The map operator is follwed by a <a href="https://www.wikiwand.com/en/Closure_(computer_programming)">closure</a> (<code>{ it["sample"] }</code>)</li>
<li>You can think of a closure as an unnamed function (like a lambda function in Python)</li>
<li>The <code>map</code> operator calls this unnamed function for each element in the channel, and creates another channel containing the respective function outputs</li>
<li>Closure understand the implicit variable <code>it</code>, which represents whatever imput is given to the function</li>
<li>If an explicit return statement is not present in the closure, the last evaluated expression is returned by the closure ( <code>it["sample"]</code> in this case)</li>
</ul></li>
<li>Since <code>splitCsv</code> created a dictionary for each item in the samplesheet, <code>map{ it["sample"] }</code> replaces that dictionary (<code>it</code> in the closure) with the content of the value contained in it under the key <code>"sample"</code></li>
<li><code>input_ch</code> is used again in <code>input_ch.map{ it["content"] }.set{ content_ch }</code> to extract the value of <code>content</code> for each sample from the samplesheet
<ul>
<li>Channels can be used many times, and each time all the files contained in it are processed. So both <code>input_ch.map{ it["content"] }.set{ content_ch }</code> and <code>input_ch.map{ it["sample"] }.set{ sample_ch }</code> process every element in <code>input_ch</code></li>
</ul></li>
<li>We created the channels <code>sample_ch</code> and <code>content_ch</code> using the <code>set</code> operator. They contain respectively the sample files and the <code>content</code> values related to them.
<ul>
<li>The order of processing in a channel is guaranteed, so we can be sure that each sample will be paired with the correct <code>content</code> value</li>
</ul></li>
<li>We fed <code>sample_ch</code> to <code>duplicate_lines</code></li>
<li>We fed the output of <code>duplicate_lines</code> to <code>append_to_file</code>, together with the values in <code>content_ch</code></li>
<li><code>append_to_file</code> appended the value of <code>content_ch</code> to the output of <code>duplicate_lines</code>, creating the final result</li>
</ul>
<p>Note that we introduced a new qualifier: <code>val</code>. The <code>val</code> qualifier specifies a value, differently from the <code>path</code> qualifier that specifies a file. If I write <code>val variable_name</code>, then <code>variable_name</code> can contain something like a string or a number, depending on what is fed to the process input.
It is also possible to manually create value channels using the channel factory <code>Channel.value</code>.
Take as an example the following</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>workflow<span class="op">{</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span><span class="op">.</span><span class="fu">value</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">).</span><span class="fu">view</span><span class="op">()</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This would produce a channel containing in order the values 1, 2, and 3. These would then be printed one by one to the terminal by the view operator.</p>
</div>
<div id="software-dependencies" class="section level2 hasAnchor" number="2.5">
<h2 class="hasAnchor"><span class="header-section-number">2.5</span> Software dependencies<a href="#software-dependencies" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We can do many things with just shell scripts, but for real-word scenarios we would probably need to use some additional library or tool.
Software dependencies for a process can be specified in Nextflow in two main ways: using <a href="https://www.docker.com/resources/what-container/">software containers</a> or <a href="https://realpython.com/python-virtual-environments-a-primer/">virtual environments</a>.</p>
<p>A software container is like a shipping container: it is a monolithic block of code and data that contains everything needed to run a specific application, including the operating system (but not the kernel, the host kernel is used). The most popular container engine (the software that is used to actually run a container) is <a href="https://www.docker.com/">Docker</a>. In high-performance clusters, for security reasons Docker is often discouraged or forbidden. A popular alternative container engine used in bioinformatics is <a href="https://sylabs.io/singularity/">Singularity</a>. The good news is that Singularity is also able to run containers created with Docker, so we can consider them equivalent for our purpose.</p>
<p>For popular tools, a container has most probably already been created by someone and put in a public container registry like <a href="https://hub.docker.com/">DockerHub</a>. In this case, we can provide to Nextflow just a link to the container and it will do the rest.
If instead we need to use a custom container, we would need to write an appropriate description file for it (called a “Dockerfile”), use it to actually build the container, and then upload the container to DockerHub.
This last use-case will not be treated in this workshop, and we will limit ourselves to the use of pre-built containers.</p>
<p>On the other hand, virtual environments are a more lightweight and modifiable alternative to containers.
They rely on the host operating system but they allow to define additional software.
Nextflow is compatible with <a href="https://docs.conda.io/en/latest/">Conda</a> environments, and can also use the faster <a href="https://mamba.readthedocs.io/en/latest/index.html">Mamba</a> implementation of Conda.
It is worth noting that while Conda/Mamba are typically thought of as package managers for Python, they are actually able to install also R packages, the R interpreter itself, stand-alone tools, and even GPU drivers.</p>
<p>Differently from containers, environments do not need to be pre-built to be used by Nextflow.
It is possible to just define the software that we need and Nextflow will take care to build an appropriate environment with it.</p>
<p>Let’s now write a workflow that makes use of virtual environments.</p>
<p>First download a csv file containing a set of countries, their population, and their area by running the following</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://raw.githubusercontent.com/saulpierotti-ebi/saulpierotti-ebi.github.io/main/assets/population_area_by_country.csv</span></code></pre></div>
<p>Now modify your <code>main.nf</code> file and make it look like this</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>nextflow<span class="op">.</span>enable<span class="op">.</span>dsl <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>process calculate_population_density <span class="op">{</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    conda <span class="st">&quot;python=3.10.6 pandas=1.5.0&quot;</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>        path csv_file</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;</span><span class="ss">${</span>csv_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.with_density.csv&quot;</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="st">        #!/usr/bin/env Python</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="st">        import pandas</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a><span class="st">        df = pandas.read_csv(&quot;</span><span class="ss">${</span>csv_file<span class="ss">}</span><span class="st">&quot;)</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a><span class="st">        df[&quot;density&quot;] = df[&quot;population&quot;] / df[&quot;area&quot;]</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="st">        df.to_csv(&quot;</span><span class="ss">${</span>csv_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.with_density.csv&quot;)</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>process plot_population_by_area <span class="op">{</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>    publishDir <span class="st">&quot;../nextflow_output/plots&quot;</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>    conda <span class="st">&quot;r-base=4.1.3 r-tidyverse=1.3.2&quot;</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>        path csv_file</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;</span><span class="ss">${</span>csv_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.pdf&quot;</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a><span class="st">        #!/usr/bin/env Rscript</span></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a><span class="st">        library(&quot;tidyverse&quot;)</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a><span class="st">        df &lt;- read_csv(&quot;</span><span class="ss">${</span>csv_file<span class="ss">}</span><span class="st">&quot;)</span></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a><span class="st">        ggplot(df, aes(x=area, y=population, label=country, size=density)) +</span></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a><span class="st">            geom_text()</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a><span class="st">        ggsave(&quot;</span><span class="ss">${</span>csv_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.pdf&quot;)</span></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>    input_ch <span class="op">=</span> <span class="bu">Channel</span><span class="op">.</span><span class="fu">fromPath</span><span class="op">(</span> params<span class="op">.</span>input <span class="op">)</span></span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculate_population_density</span><span class="op">(</span> input_ch <span class="op">)</span></span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_population_by_area</span><span class="op">(</span> calculate_population_density<span class="op">.</span>out <span class="op">)</span></span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Modify your <code>nextflow.config</code> by adding the following</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>conda <span class="op">{</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// use the faster mamba solver instead of conda</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    useMamba <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If you want to see how your <code>nextflow.config</code> should look like at this stage open this hidden section</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb44"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">// you can also put comments in nextflow.config</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>workDir <span class="op">=</span> <span class="st">&quot;../nextflow_workdir&quot;</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>params <span class="op">{</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  samplesheet <span class="op">=</span> <span class="st">&quot;../nextflow_inputs/samplesheet.csv&quot;</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>conda <span class="op">{</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// use the faster mamba solver instead of conda</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    useMamba <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</details>
<p>Now run the workflow as follows</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nextflow</span> run main.nf <span class="at">--input</span> population_area_by_country.csv</span></code></pre></div>
<p>This time the workflow will take significantly longer to run since Nextflow needs to create two mamba environments.
However, this will affect only the first run of the workflow, since once an environment is created it can be used multiple times.
Now open the file <code>../nextflow_output/plots/population_area_by_country.pdf</code>.
It will contain a plot of the population of different countries versus their area, with the size proportional to their population density.</p>
<p>Let’s explore what happened:</p>
<ul>
<li>We specified to Nextflow to use mamba instead than conda when using the conda directive (with <code>conda{use.mamba = true}</code> in <code>nextflow.config</code>)</li>
<li>As before, we used a command-line flag to pass an input file to the workflow (<code>--input population_area_by_country.csv</code>)</li>
<li>We used <code>population_area_by_country.csv</code> as an input for the process <code>calculate_population_density</code>, which uses Python code to calculate the population density of a country from its area and total population</li>
<li>The output of <code>calculate_population_density</code> is fed to the process <code>plot_population_by_area</code>, which uses R code to produce the plot</li>
</ul>
<p>The <code>conda</code> directive used in these processes defines the software dependencies needed, in this case Python and <a href="https://pandas.pydata.org/">pandas</a> for the first process and R and <a href="https://www.tidyverse.org/">tidyverse</a> for the second process.
Software versions can be specified with an equal sign after the software name.
Packages are sourced from the repository <a href="https://anaconda.org/">Anaconda</a>.</p>
<p>Another thing to note here: the <code>script</code> directive normally interprets the code written in it as bash code, but if an sh-bang (<code>!#</code>) is included in the first line of the script, then the software specified in the sh-bang is used to run the script section (so <code>!#/usr/bin/env Python</code> tells to Nextflow to interpret the script section as Python code).</p>
<p>A different approach to reach the same goal is to write a separate Python or R script, place it in the <code>bin</code> folder, and then execute it with a bash command in the script directive.</p>
<p>So for example you can create a file called <code>bin/calculate_population_density.py</code> with the following content</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pandas.read_csv(sys.argv[<span class="dv">1</span>])</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&quot;density&quot;</span>] <span class="op">=</span> df[<span class="st">&quot;population&quot;</span>] <span class="op">/</span> df[<span class="st">&quot;area&quot;</span>]</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>df.to_csv(sys.argv[<span class="dv">2</span>])</span></code></pre></div>
<p>Make it executable with</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x bin/calculate_population_density.py</span></code></pre></div>
<p>And change the <code>calculate_population_density</code> process as follows</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>process calculate_population_density <span class="op">{</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    conda <span class="st">&quot;python=3.10.6 pandas=1.5.0&quot;</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>        path csv_file</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;</span><span class="ss">${</span>csv_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.with_density.csv&quot;</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="st">        ./calculate_population_density.py </span><span class="ss">$csv_file</span><span class="st"> </span><span class="ss">${</span>csv_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.with_density.csv</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Running the following will yield the same result as before</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nextflow</span> run main.nf <span class="at">--input</span> population_area_by_country.csv</span></code></pre></div>
<p>If we wanted to use containers instead than virtual environments for the process <code>calculate_population_density</code> to specify our software dependencies, we could have just replaced the line</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>conda <span class="st">&quot;python=3.10.6 pandas=1.5.0&quot;</span></span></code></pre></div>
<p>with the line</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>container <span class="st">&quot;docker://amancevice/pandas&quot;</span></span></code></pre></div>
<p>And then we would need to either set <code>docker{enabled = true}</code> or <code>singularity{enabled = true}</code> on our <code>nextflow.config</code> file, or we could specify the flag <code>-with-docker</code> or <code>-with-singularity</code> from the command line.
A similar approach would work also for the process <code>plot_population_by_area</code>, using for example the container <code>docker:/rocker/tidyverse</code>.</p>
<p>Note that containers in the format <code>docker:/username/container</code> are pulled by Nextflow from DockerHub.
They can be used either with Docker or Singularity.</p>
</div>
<div id="resource-allocation" class="section level2 hasAnchor" number="2.6">
<h2 class="hasAnchor"><span class="header-section-number">2.6</span> Resource allocation<a href="#resource-allocation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Resource allocation is very useful when our workflow is run on a high performance cluster or in the cloud.
It is possible to specify the amount of <a href="https://www.wikiwand.com/en/Random-access_memory">RAM</a>, the number of <a href="https://www.wikiwand.com/en/Central_processing_unit">CPU cores</a>, and the running time required by a process.
These values are then used by Nextflow to reserve appropriate resources, for example to submit a job to the cluster with the desired requirements.</p>
<p>Since we do not have a cluster environment available for this workshop, we will not try to implement an actual workflow using resource requirements (we could specify them also for a local workflow, but we would not see any effect).</p>
<p>An example process specifying resource requirements looks like this</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>process calculate_population_density <span class="op">{</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// this can be in GB, MB, KB, TB, ...</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    memory <span class="st">&quot;2 GB&quot;</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// this can be in second(s), minute(s), hour(s), day(s)</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// it is also possible to use abbreviations such as s, m, h, d</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    time <span class="st">&quot;5 days&quot;</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// just an integer (note that this is not a string)</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    cpus <span class="dv">4</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>        path csv_file</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;</span><span class="ss">${</span>csv_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.with_density.csv&quot;</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="st">        ./calculate_population_density.py </span><span class="ss">$csv_file</span><span class="st"> </span><span class="ss">${</span>csv_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.with_density.csv</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="the-resume-feature" class="section level2 hasAnchor" number="2.7">
<h2 class="hasAnchor"><span class="header-section-number">2.7</span> The resume feature<a href="#the-resume-feature" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>One of the most powerful aspects of Nextflow is the resume feature.
This feature can be activated by adding the following to the <code>nextflow.config</code> file</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>resume <span class="op">=</span> <span class="kw">true</span></span></code></pre></div>
<p>Alternatively, it is also possible to run the Nextflow command with the <code>-resume</code> flag.</p>
<p>We saw before that each task is executed by Nextflow in its own directory with a long alphanumeric name.
This name is not random, but it is a 128-bit <a href="https://www.wikiwand.com/en/Hash_function">hash number</a>.
This number is calculated from the following values:</p>
<ul>
<li>Input files</li>
<li>Command line string</li>
<li>Container ID</li>
<li>Conda environment</li>
<li>Environment modules</li>
<li>Any executed scripts in the bin directory</li>
</ul>
<p>So, any time one of the following features of a process changes, the hash value and hence the working directory changes.</p>
<p>If a working directory with the same hash value as the one of the task to be executed is found by Nextflow, and this folder contains all the required outputs declared in the <code>output</code> block of the process, and it contains a file called <code>.exitcode</code> containing a value of zero (this is created automatically by Nextflow to save the exit code of a task execution), then the task execution is skipped and the output files present in the directory are returned as if they were produced by the current task.</p>
<p>This feature allows to resume the execution of a previous failed run of a workflow from the last successful task, potentially saving a lot of computing time.
A more in-depth explanation of the resume feature is available <a href="https://www.nextflow.io/blog/2019/demystifying-nextflow-resume.html">here</a>.</p>
<p>To test the resume feature by ourselves, lets modify our <code>main.nf</code> file as follows</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>nextflow<span class="op">.</span>enable<span class="op">.</span>dsl <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>process dumb_process <span class="op">{</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    publishDir <span class="st">&quot;../nextflow_output&quot;</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;out.txt&quot;</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="st">        sleep 120</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;Success!&quot; &gt; out.txt</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dumb_process</span><span class="op">()</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Now you can run the workflow with <code>nextflow run main.nf</code>.
Our workflow just runs the process <code>dumb_process</code>, which does not take any input and declares a single output file, <code>out.txt</code>.
This execution will take 2 minutes since the script block of the process <code>dumb_process</code> contains the command <code>sleep 120</code>, which just waits for 2 minutes (120 seconds), before writing the line “Success!” to the file <code>out.txt</code>.
After the execution is complete, we can see that the line “Success!” is present in the output file by running</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ../nextflow_output/out.txt</span></code></pre></div>
<p>Now, to test the resume feature run again the workflow</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nextflow</span> run main.nf <span class="at">-resume</span></span></code></pre></div>
<p>In this case, the execution will be much quicker since <code>process_dumb</code> is not actually executed, but the cached results obtained before are returned.</p>
</div>
<div id="nf-core-pipelines" class="section level2 hasAnchor" number="2.8">
<h2 class="hasAnchor"><span class="header-section-number">2.8</span> nf-core pipelines<a href="#nf-core-pipelines" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Many of the workflow that we need in our work as bioinformatics are always the same, mapping sequencing reads to a reference and then performing variant calling for example.</p>
<p>For such common use-cases, very efficient Nextflow pipelines are already available, so there is no need to re-invent the wheel.
Community-curated pipelines can be found on the <a href="https://nf-co.re">nf-core</a> repository.
So for example for mapping reads to a reference and then performing variant calling we would use the <a href="https://nf-co.re/sarek"><code>nf-core/sarek</code></a> pipeline.
These pipelines follow a standardised format where inputs are declared by the user in a sample sheet.
You can read each pipeline’s documentation in nf-core to learn more about the parameters available and the expected sample sheet.</p>
<p>I cannot make you run an actual nf-core pipeline now since there is not a simple and self-contained pipeline that does not require additional data like sequencing files to be run. However, once you have some files to process and you wrote an appropriate sample sheet, running the pipeline is very easy, for example:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nextflow</span> run nf-core/sarek</span></code></pre></div>
<p>Note that Nextflow is able to run workflows from <a href="https://github.com/">GitHub</a>, and <code>nf-core/sarek</code> in the command above is just a pointer to <a href="https://github.com/nf-core/sarek">this GitHub repository</a>.
Nextflow takes care of cloning the repository and running the <code>main.nf</code> file.</p>
<p>If you want to actually test running a pipeline written by someone else, run the following hello world pipeline:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nextflow</span> run nextflow-io/hello</span></code></pre></div>
<p>This will just print “Hello World” in different languages to the terminal.
You can explore the code for this workflow <a href="https://github.com/nextflow-io/hello">here</a>.</p>
</div>
<div id="labels" class="section level2 hasAnchor" number="2.9">
<h2 class="hasAnchor"><span class="header-section-number">2.9</span> Labels<a href="#labels" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The <code>label</code> directive is used in Nextflow to tag processes to which we want to apply specific configurations.
So for example going back to the process <code>calculate_population_density</code></p>
<div class="sourceCode" id="cb59"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>process calculate_population_density <span class="op">{</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    conda <span class="st">&quot;python=3.10.6 pandas=1.5.0&quot;</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>        path csv_file</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;</span><span class="ss">${</span>csv_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.with_density.csv&quot;</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a><span class="st">        ./calculate_population_density.py </span><span class="ss">$csv_file</span><span class="st"> </span><span class="ss">${</span>csv_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.with_density.csv</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Instead than hard-coding the <code>conda</code> directive into the process definition, we could have done as follows</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>process calculate_population_density <span class="op">{</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    label <span class="st">&quot;pandas&quot;</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>        path csv_file</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;</span><span class="ss">${</span>csv_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.with_density.csv&quot;</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="st">        ./calculate_population_density.py </span><span class="ss">$csv_file</span><span class="st"> </span><span class="ss">${</span>csv_file<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.with_density.csv</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>And then in the <code>nextflow.config</code> we could have written</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>withLabel<span class="op">:</span>pandas <span class="op">{</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    conda <span class="op">=</span> <span class="st">&quot;python=3.10.6 pandas=1.5.0&quot;</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This may seem of little benefit for a single process, but if we have many processes with similar requirements, using the <code>label</code> directive allows us to specify such requirements only once and in a central location.
So if for example we have several processes that need Python and pandas as software requirements, and we specified the requirements using the label directive, we can change the version of pandas used just by modifying what we wrote in the <code>nextflow.config</code> file, instead than having to modify the definition of many processes.</p>
<p>Note that the <code>label</code> directive can be used to specify many different configurations, not only software requirements.
For example, we could use it also for memory or time requirements.</p>
</div>
</div>
<div id="basic-challenge" class="section level1 hasAnchor" number="3">
<h1 class="hasAnchor"><span class="header-section-number">3</span> Basic challenge<a href="#basic-challenge" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>It’s now time to put into practice what you learned today!
Try to solve the following challenge.
The aim is to write a functioning workflow that takes in input the following sample sheet</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="ex">filename,value,number_of_rows,number_of_columns</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="ex">file1.txt,3,10,10</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="ex">file2.txt,7,5,45</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="ex">file3.txt,a_value,45,1</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="ex">file4.txt,trweter,43,9</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="ex">file5.txt,109,14,3</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="ex">file6.txt,aaa,1,12</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="ex">file7.txt,g,96,76</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="ex">file8.txt,eew,11,11</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="ex">file9.txt,1ww,21,34</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a><span class="ex">file10.txt,45,8,2</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="ex">file11.txt,jh,6,1</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="ex">file12.txt,96,1,5</span></span></code></pre></div>
<p>For each file in the sample sheet (under the <code>filename</code> column), the workflow should create in output a file with such name and place it in the folder <code>../nextflow_output/challenge</code>.
Each file should contain the content of the column <code>value</code> for that file.
This content should be repeated <code>number_of_columns</code> times in the same line, each instance separated by a comma.
The file should contain <code>number_of_rows</code> times the above mentioned row.
So at the end, each file should be essentially a csv file with <code>number_of_rows</code> rows and <code>number_of_columns</code> columns, without header, and with each cell containing <code>value</code>.</p>
<p>For example, <code>../nextflow_output/challenge/file1.txt</code> should contain</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="ex">3,3,3,3,3,3,3,3,3,3</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="ex">3,3,3,3,3,3,3,3,3,3</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="ex">3,3,3,3,3,3,3,3,3,3</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="ex">3,3,3,3,3,3,3,3,3,3</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="ex">3,3,3,3,3,3,3,3,3,3</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="ex">3,3,3,3,3,3,3,3,3,3</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="ex">3,3,3,3,3,3,3,3,3,3</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="ex">3,3,3,3,3,3,3,3,3,3</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="ex">3,3,3,3,3,3,3,3,3,3</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="ex">3,3,3,3,3,3,3,3,3,3</span></span></code></pre></div>
<p>You can use as many or as few processes as you want to achieve this result. The challenge is possible using only the Nextflow features that we discussed, and a bit of bash or Python/R scripting.</p>
<p>You can find the solution to the challenge by disclosing the following block.</p>
<details>
<summary>
Click here to see the solution (<code>main.nf</code> file)
</summary>
<div class="sourceCode" id="cb64"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>nextflow<span class="op">.</span>enable<span class="op">.</span>dsl <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>process create_matrix <span class="op">{</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    conda <span class="st">&quot;r-base r-tidyverse&quot;</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    publishDir <span class="st">&quot;../nextflow_output/challenge&quot;</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tuple</span><span class="op">(</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>            <span class="fu">val</span><span class="op">(</span>outname<span class="op">),</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>            <span class="fu">val</span><span class="op">(</span>fill_value<span class="op">),</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>            <span class="fu">val</span><span class="op">(</span>nrows<span class="op">),</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>            <span class="fu">val</span><span class="op">(</span>ncols<span class="op">)</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;</span><span class="ss">$outname</span><span class="st">&quot;</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a><span class="st">        #!/usr/bin/env Rscript</span></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a><span class="st">        library(&quot;tidyverse&quot;)</span></span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a><span class="st">        content &lt;- rep(&quot;</span><span class="ss">$fill_value</span><span class="st">&quot;, </span><span class="ss">${</span>ncols<span class="ss">}</span><span class="st">*</span><span class="ss">${</span>nrows<span class="ss">}</span><span class="st">)</span></span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a><span class="st">        mat &lt;- matrix(content, </span><span class="ss">${</span>nrows<span class="ss">}</span><span class="st">, </span><span class="ss">${</span>ncols<span class="ss">}</span><span class="st">)</span></span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a><span class="st">        df &lt;- as.tibble(mat)</span></span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a><span class="st">        write_csv(df, &quot;</span><span class="ss">${</span>outname<span class="ss">}</span><span class="st">&quot;, col_names=FALSE)</span></span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Channel</span><span class="op">.</span><span class="fu">fromPath</span><span class="op">(</span> params<span class="op">.</span>input <span class="op">)</span></span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">splitCsv</span><span class="op">(</span>header<span class="op">:</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">map</span><span class="op">{</span></span>
<span id="cb64-39"><a href="#cb64-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span> it<span class="op">[</span><span class="st">&quot;filename&quot;</span><span class="op">],</span> it<span class="op">[</span><span class="st">&quot;value&quot;</span><span class="op">],</span> it<span class="op">[</span><span class="st">&quot;number_of_rows&quot;</span><span class="op">],</span> it<span class="op">[</span><span class="st">&quot;number_of_columns&quot;</span><span class="op">]</span> <span class="op">]</span></span>
<span id="cb64-40"><a href="#cb64-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb64-41"><a href="#cb64-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">set</span><span class="op">{</span> input_ch <span class="op">}</span></span>
<span id="cb64-42"><a href="#cb64-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-43"><a href="#cb64-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">create_matrix</span><span class="op">(</span> input_ch <span class="op">)</span></span>
<span id="cb64-44"><a href="#cb64-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If the sample sheet is saved as <code>../nextflow_output/samplesheet.csv</code>, the solution can be run with the following command</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nextflow</span> run main.nf <span class="at">--input</span> ../nextflow_output/samplesheet.csv</span></code></pre></div>
</details>
<!--chapter:end:02-basic.Rmd-->
</div>
<div id="advanced-features" class="section level1 hasAnchor" number="4">
<h1 class="hasAnchor"><span class="header-section-number">4</span> Advanced features<a href="#advanced-features" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>If you are reading the advanced section of this workshop I am assuming that you are already familiar with what are workflows, processes, and operators.
I am also assuming that you know how a Nextflow workflow is structured and you understand the syntax and logic used in writing and configuring Nextflow pipelines.
For this reason, you will find the following section to be a bit different from the ones that came before.
I will not walk you through complete reproducible examples as I did until now, but I will present small snippets of code that show some specific functionality or practice that I deemed to be useful to know.
You are supposed to try out by yourself these ideas, and see how they can be applied to your own use-case.</p>
<div id="process-inputs" class="section level2 hasAnchor" number="4.1">
<h2 class="hasAnchor"><span class="header-section-number">4.1</span> Process inputs<a href="#process-inputs" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The input(s) used by a process is defined in its <code>input:</code> block, as we saw before.
The input(s) specified can be of several types.
We already saw in the basic section of this workshop the <code>path</code> and <code>val</code> input qualifiers.
We will see them more in details now, as well as explore some additional input qualifiers.</p>
<div id="input-of-type-val" class="section level3 hasAnchor" number="4.1.1">
<h3 class="hasAnchor"><span class="header-section-number">4.1.1</span> Input of type <code>val</code><a href="#input-of-type-val" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>An input of type <code>val</code> just defines a value, that is made available to the process as a variable.</p>
<p>As an example, the following code writes the value “Good morning” to the file called <code>my_file.txt</code>.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>process say_hello <span class="op">{</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  input<span class="op">:</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    val greeting_sentence</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  output<span class="op">:</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    path <span class="st">&quot;my_file.txt&quot;</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>  script<span class="op">:</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="st">    echo </span><span class="ss">$greeting_sentence</span><span class="st"> &gt; my_file.txt</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span><span class="op">.</span><span class="fu">value</span><span class="op">(</span><span class="st">&quot;Good morning&quot;</span><span class="op">).</span><span class="fu">set</span><span class="op">{</span> my_ch <span class="op">}</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">say_hello</span><span class="op">(</span> my_ch <span class="op">)</span></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="input-of-type-path" class="section level3 hasAnchor" number="4.1.2">
<h3 class="hasAnchor"><span class="header-section-number">4.1.2</span> Input of type <code>path</code><a href="#input-of-type-path" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>An input of type <code>path</code> stages a file in the working directory of the process, and makes the filename available to the process under the variable declared.</p>
<p>As an example, the following code just reads the file <code>/path/to/a/file.txt</code> to the standard output.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>process read_file <span class="op">{</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  input<span class="op">:</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    path my_file</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  script<span class="op">:</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="st">    cat </span><span class="ss">$my_file</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span><span class="op">.</span><span class="fu">fromPath</span><span class="op">(</span><span class="st">&quot;/path/to/a/file.txt&quot;</span><span class="op">).</span><span class="fu">set</span><span class="op">{</span> my_ch <span class="op">}</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_file</span><span class="op">(</span> my_ch <span class="op">)</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="input-of-type-tuple" class="section level3 hasAnchor" number="4.1.3">
<h3 class="hasAnchor"><span class="header-section-number">4.1.3</span> Input of type <code>tuple</code><a href="#input-of-type-tuple" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>An input of type <code>tuple</code> can be used when the channel given in input to the process emits lists of elements instead than single elements.
The elements contained in the list can be of any type, like for example <code>val</code> or <code>path</code>.</p>
<p>As an example, the following code appends the value “Good morning” to the file <code>/path/to/a/file.txt</code>.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>process append_value_to_file <span class="op">{</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  input<span class="op">:</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tuple</span><span class="op">(</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">path</span><span class="op">(</span>my_file<span class="op">),</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">val</span><span class="op">(</span>my_value<span class="op">)</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>  script<span class="op">:</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="st">    echo </span><span class="ss">$my_value</span><span class="st"> &gt;&gt; </span><span class="ss">$my_file</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span> <span class="op">[</span> <span class="st">&quot;Good morning&quot;</span><span class="op">,</span> <span class="st">&quot;/path/to/a/file.txt&quot;</span> <span class="op">]</span> <span class="op">).</span><span class="fu">set</span><span class="op">{</span> my_ch <span class="op">}</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">append_value_to_file</span><span class="op">(</span> my_ch <span class="op">)</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div id="process-outputs" class="section level2 hasAnchor" number="4.2">
<h2 class="hasAnchor"><span class="header-section-number">4.2</span> Process outputs<a href="#process-outputs" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Process outputs can have similar types to the ones used for process inputs.
So for example the output of a process can be a <code>path</code> variable (a file), a <code>val</code> variable (a groovy variable), or a <code>tuple</code> of such elements.
Other output types exist in Nextflow, but we will not treat them here.</p>
<p>Read <a href="https://www.nextflow.io/docs/latest/process.html#outputs">here</a> for more details.</p>
<p>See the following example:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>process append_value_to_file <span class="op">{</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  input<span class="op">:</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tuple</span><span class="op">(</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">path</span><span class="op">(</span>my_file<span class="op">),</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">val</span><span class="op">(</span>my_value<span class="op">)</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  output<span class="op">:</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tuple</span><span class="op">(</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">path</span><span class="op">(</span>my_file<span class="op">),</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">val</span><span class="op">(</span>my_value<span class="op">)</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>  script<span class="op">:</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a><span class="st">    echo </span><span class="ss">$my_value</span><span class="st"> &gt;&gt; </span><span class="ss">$my_file</span></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Channel</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span> <span class="op">[</span> <span class="st">&quot;Good morning&quot;</span><span class="op">,</span> <span class="st">&quot;/path/to/a/file.txt&quot;</span> <span class="op">]</span> <span class="op">).</span><span class="fu">set</span><span class="op">{</span> my_ch <span class="op">}</span></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">append_value_to_file</span><span class="op">(</span> my_ch <span class="op">)</span></span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>In this example we see the same process as before, but this time we declared an output block.
The output is of type <code>tuple</code>, with two elements contained in it (one of type <code>path</code> and the other of type <code>val</code>).
After execution of the process <code>append_value_to_file</code>, the channel <code>append_value_to_file.out</code> will contain a list of two elements.
The first element will be the filename given in input, and the second element will be the value given in input.
Note that the file produced in output by the process will not be the same file given in input to it: it will have been modified in the <code>script</code> block by appending <code>my_value</code> to it.</p>
</div>
<div id="the-groovy-programming-language" class="section level2 hasAnchor" number="4.3">
<h2 class="hasAnchor"><span class="header-section-number">4.3</span> The Groovy programming language<a href="#the-groovy-programming-language" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Here we will talk about some features of the Groovy programming language, on which Nextflow is based, that can be useful when writing workflows.
If you want to test out some Groovy code interactively, head off to <a href="https://groovyconsole.appspot.com/">this website</a> and paste the code snippets that we will introduce.</p>
<div id="closures" class="section level3 hasAnchor" number="4.3.1">
<h3 class="hasAnchor"><span class="header-section-number">4.3.1</span> Closures<a href="#closures" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We already introduced closures in previous section, where we used them in conjunction with the map operator.
In general, we can consider a closure as a unnamed function, defined as a statement enclosed in curly brackets.
The following is a closure</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> it<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">}</span></span></code></pre></div>
<p>We can manually define the inputs and outputs of a closure.
For example:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  x<span class="op">,</span> y <span class="op">-&gt;</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  z <span class="op">=</span> x <span class="op">+</span> y</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> z</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>In the above defined example the closure expects two inputs, (<code>x,y -&gt;</code>), some operation is performed on them (<code>z = x + y</code>), and a value is explicitly returned (<code>return z</code>).
The definition of inputs is optional, and indeed it is usually skipped.
If an input is not defined, the implicit variable <code>it</code> is used to refer to any input passed to the closure.
So we could write the following, assuming that a tuple of two elements is passed as an input to the closure</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  z <span class="op">=</span> it<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span> it<span class="op">[</span><span class="dv">1</span><span class="op">]</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> z</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>What’s more, it is possible to also omit the <code>return</code> statement from a closure.
In this case, the last evaluated expression is returned.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> it<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span> it<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">}</span></span></code></pre></div>
<p>As shown in the previous example, closures can be split on multiple lines or they can be written on a single line.
They can contain any valid Groovy code statement.
For example:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="cf">if</span> <span class="op">(</span> it <span class="op">&lt;</span> <span class="dv">1</span> <span class="op">)</span> <span class="op">{</span><span class="st">&quot;small&quot;</span><span class="op">}</span> <span class="cf">else</span> <span class="op">{</span> <span class="st">&quot;big&quot;</span> <span class="op">}</span> <span class="op">}</span></span></code></pre></div>
</div>
<div id="conditional-statements" class="section level3 hasAnchor" number="4.3.2">
<h3 class="hasAnchor"><span class="header-section-number">4.3.2</span> Conditional statements<a href="#conditional-statements" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Conditional statements in Groovy can be written in several ways.
The simplest approach is that of a classic if/else statement.
This can be written, for example, as follows.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span> x <span class="op">&lt;</span> <span class="dv">1</span> <span class="op">)</span> <span class="op">{</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  y <span class="op">=</span> <span class="st">&quot;small&quot;</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  y <span class="op">=</span> <span class="st">&quot;big&quot;</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>A more compact syntax to achieve the same result takes advantage of the ternary operator</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> <span class="op">(</span> x <span class="op">&lt;</span> <span class="dv">1</span> <span class="op">)</span> <span class="op">?</span> <span class="st">&quot;small&quot;</span> <span class="op">:</span> <span class="st">&quot;big&quot;</span></span></code></pre></div>
<p>In case when the return value desired for the <code>TRUE</code> case is the statement itself, the Elvis operator can be used</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> my_list <span class="op">?:</span> <span class="st">&quot;list is empty&quot;</span></span></code></pre></div>
<p>In the latter case the variable <code>y</code> will contain the content of <code>my_list</code> if this is not empty, otherwise the string <code>list is empty</code>.</p>
</div>
</div>
<div id="channel-factories" class="section level2 hasAnchor" number="4.4">
<h2 class="hasAnchor"><span class="header-section-number">4.4</span> Channel factories<a href="#channel-factories" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Besides the <code>Channel.fromPath</code> and <code>Channel.value</code> channel factories that we saw before, another useful Channel factory (especially for debugging purposes) is <code>Channel.of</code>.
<code>Channel.of</code> allows you tu put into a channel any Groovy data structure like lists, hash maps, and so on.
So takes as an example the following:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Channel</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;EBI&quot;</span><span class="op">,</span> <span class="st">&quot;type&quot;</span><span class="op">:</span> <span class="st">&quot;institute&quot;</span><span class="op">,</span> <span class="st">&quot;location&quot;</span><span class="op">:</span> <span class="st">&quot;UK&quot;</span><span class="op">],</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;GB&quot;</span><span class="op">,</span> <span class="st">&quot;type&quot;</span><span class="op">:</span> <span class="st">&quot;institute&quot;</span><span class="op">,</span> <span class="st">&quot;location&quot;</span><span class="op">:</span> <span class="st">&quot;Germany&quot;</span><span class="op">],</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span></code></pre></div>
<p>This will create a channel emitting two elements, each of them a Groovy map containing three elements.
What especially differentiates <code>Channel.of</code> from <code>Channel.value</code> is that the latter can contain only a single element.</p>
</div>
<div id="operators" class="section level2 hasAnchor" number="4.5">
<h2 class="hasAnchor"><span class="header-section-number">4.5</span> Operators<a href="#operators" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In the basic section of this workshop, we introduced a few Nextflow operators: <code>map</code>, <code>splitCsv</code>, <code>view</code>.
Here we will more formally describe such operators and also look at additional operators that can be helpful for workflows with a more complex logic.Note that this is not an exhaustive list.
An exhaustive list can be found <a href="https://www.nextflow.io/docs/latest/operator.html#">here</a>.</p>
<div id="the-view-operator" class="section level3 hasAnchor" number="4.5.1">
<h3 class="hasAnchor"><span class="header-section-number">4.5.1</span> The <code>view</code> operator<a href="#the-view-operator" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>view</code> operator just prints to the terminal the content of the channel, one element per line.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Channel</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">).</span><span class="fu">view</span><span class="op">()</span></span></code></pre></div>
<p>Expected output:</p>
<pre><code>1
2
3</code></pre>
</div>
<div id="the-map-operator" class="section level3 hasAnchor" number="4.5.2">
<h3 class="hasAnchor"><span class="header-section-number">4.5.2</span> The <code>map</code> operator<a href="#the-map-operator" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>map</code> operator can be used to modify the content of a channel on the fly.
For example, it can be used to extract just some elements from a channel emitting lists.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Channel</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;EBI&quot;</span><span class="op">,</span> <span class="st">&quot;type&quot;</span><span class="op">:</span> <span class="st">&quot;institute&quot;</span><span class="op">,</span> <span class="st">&quot;location&quot;</span><span class="op">:</span> <span class="st">&quot;UK&quot;</span><span class="op">],</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;GB&quot;</span><span class="op">,</span> <span class="st">&quot;type&quot;</span><span class="op">:</span> <span class="st">&quot;institute&quot;</span><span class="op">,</span> <span class="st">&quot;location&quot;</span><span class="op">:</span> <span class="st">&quot;Germany&quot;</span><span class="op">],</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span><span class="op">{</span> it<span class="op">[</span><span class="st">&quot;name&quot;</span><span class="op">]</span> <span class="op">}</span></span></code></pre></div>
<p>Expected output:</p>
<pre><code>EBI
GB</code></pre>
</div>
<div id="the-set-operator" class="section level3 hasAnchor" number="4.5.3">
<h3 class="hasAnchor"><span class="header-section-number">4.5.3</span> The <code>set</code> operator<a href="#the-set-operator" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>set</code> operator creates assigns a name to the channel, given as a closure argument.</p>
<pre><code>Channel.of(1, 2, 3).set{ my_ch }</code></pre>
<p>The above snippets creates a channel called <code>my_ch</code> with the values specified.</p>
</div>
<div id="the-splitcsv-operator" class="section level3 hasAnchor" number="4.5.4">
<h3 class="hasAnchor"><span class="header-section-number">4.5.4</span> The <code>splitCsv</code> operator<a href="#the-splitcsv-operator" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>splitCsv</code> operator is usually used to process a sample sheet.
It takes a <code>path</code> channel containing a csv file and emits each line of the csv as a list of values (or as a hash map if <code>header: true</code> is specified).</p>
</div>
<div id="the-flatten-operator" class="section level3 hasAnchor" number="4.5.5">
<h3 class="hasAnchor"><span class="header-section-number">4.5.5</span> The <code>flatten</code> operator<a href="#the-flatten-operator" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>flatten</code> operator will take all the elements in a channel and split them in single elements.
If the channel emits lists or nested lists, they are flattened and each element is emitted independently.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Channel</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">],</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="st">&quot;aa&quot;</span><span class="op">,</span> <span class="st">&quot;bb&quot;</span><span class="op">,</span> <span class="st">&quot;cc&quot;</span><span class="op">]</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">flatten</span><span class="op">()</span></span></code></pre></div>
<p>Expected output:</p>
<pre><code>1
2
3
aa
bb
cc</code></pre>
</div>
<div id="the-collect-operator" class="section level3 hasAnchor" number="4.5.6">
<h3 class="hasAnchor"><span class="header-section-number">4.5.6</span> The <code>collect</code> operator<a href="#the-collect-operator" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>collect</code> operator is in a way performing the opposite operation of the <code>flatten</code> operator.
It takes all the elements in a channel and collects them in a single list, which is then emitted all at once.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Channel</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">],</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="st">&quot;aa&quot;</span><span class="op">,</span> <span class="st">&quot;bb&quot;</span><span class="op">,</span> <span class="st">&quot;cc&quot;</span><span class="op">]</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">collect</span><span class="op">()</span></span></code></pre></div>
<p>Expected output:</p>
<pre><code>[1, 2, 3, aa, bb, cc]</code></pre>
</div>
<div id="the-filter-operator" class="section level3 hasAnchor" number="4.5.7">
<h3 class="hasAnchor"><span class="header-section-number">4.5.7</span> The <code>filter</code> operator<a href="#the-filter-operator" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>filter</code> operator filters the elements of a channel, emitting only the ones for which a condition is satisfied.
The condition is provided as a closure, with a boolean return value.
It is also possible to use a regular expression as a test, but we will not treat it here.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Channel</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">)</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span><span class="op">{</span> it <span class="op">&gt;</span> <span class="dv">3</span> <span class="op">}</span></span></code></pre></div>
<p>Expected output:</p>
<pre><code>4
5</code></pre>
</div>
<div id="the-first-operator" class="section level3 hasAnchor" number="4.5.8">
<h3 class="hasAnchor"><span class="header-section-number">4.5.8</span> The <code>first</code> operator<a href="#the-first-operator" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>first</code> operator just emits the first element of a channel.
Useful for testing the logic without running the full workflow.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Channel</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">).</span><span class="fu">first</span><span class="op">()</span></span></code></pre></div>
<p>Expected output:</p>
<pre><code>1</code></pre>
</div>
<div id="the-combine-operator" class="section level3 hasAnchor" number="4.5.9">
<h3 class="hasAnchor"><span class="header-section-number">4.5.9</span> The <code>combine</code> operator<a href="#the-combine-operator" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The combine operator creates the Cartesian product of two channels (all the possible combinations of elements).</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Channel</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">).</span><span class="fu">set</span><span class="op">{</span> ch_1 <span class="op">}</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Channel</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="st">&quot;a&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">,</span> <span class="st">&quot;c&quot;</span><span class="op">).</span><span class="fu">set</span><span class="op">{</span> ch_2 <span class="op">}</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>ch_1<span class="op">.</span><span class="fu">combine</span><span class="op">(</span>ch_2<span class="op">)</span></span></code></pre></div>
<p>Expected output:</p>
<pre><code>[1, a]
[2, a]
[1, b]
[2, b]
[3, a]
[3, b]
[1, c]
[2, c]
[3, c]</code></pre>
<p>The <code>combine</code> operator can also be used to join elements that present a matching key from two channels.
This is achieved by specifying the <code>by</code> argument, with an integer specifying the position in the tuple to use as a matching key.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Channel</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="st">&quot;key1&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">],</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="st">&quot;key2&quot;</span><span class="op">,</span> <span class="dv">2</span><span class="op">],</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="st">&quot;key3&quot;</span><span class="op">,</span> <span class="dv">3</span><span class="op">],</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="op">).</span><span class="fu">set</span><span class="op">{</span> ch_1 <span class="op">}</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="bu">Channel</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="st">&quot;key3&quot;</span><span class="op">,</span> <span class="st">&quot;aa&quot;</span><span class="op">],</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="st">&quot;key1&quot;</span><span class="op">,</span> <span class="st">&quot;bb&quot;</span><span class="op">],</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="st">&quot;key2&quot;</span><span class="op">,</span> <span class="st">&quot;cc&quot;</span><span class="op">],</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="op">).</span><span class="fu">set</span><span class="op">{</span> ch_2 <span class="op">}</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>ch_1<span class="op">.</span><span class="fu">combine</span><span class="op">(</span>ch_2<span class="op">,</span> by<span class="op">:</span> <span class="dv">0</span><span class="op">)</span></span></code></pre></div>
<p>Expected output:</p>
<pre><code>[key1, 1, bb]
[key3, 3, aa]
[key2, 2, cc]</code></pre>
</div>
<div id="the-grouptuple-operator" class="section level3 hasAnchor" number="4.5.10">
<h3 class="hasAnchor"><span class="header-section-number">4.5.10</span> The <code>groupTuple</code> operator<a href="#the-grouptuple-operator" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>groupTuple</code> operator collects the elements of a channel according to a matching key (whose position is specified with the <code>by</code> argument).</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Channel</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="st">&quot;key1&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">],</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="st">&quot;key2&quot;</span><span class="op">,</span> <span class="dv">2</span><span class="op">],</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="st">&quot;key1&quot;</span><span class="op">,</span> <span class="dv">3</span><span class="op">],</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="st">&quot;key2&quot;</span><span class="op">,</span> <span class="dv">4</span><span class="op">],</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span><span class="st">&quot;key1&quot;</span><span class="op">,</span> <span class="dv">4</span><span class="op">],</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a><span class="op">.</span><span class="fu">groupTuple</span><span class="op">(</span>by<span class="op">:</span> <span class="dv">0</span><span class="op">)</span></span></code></pre></div>
<p>Expected output:</p>
<pre><code>[key1, [1, 3, 4]]
[key2, [2, 4]]</code></pre>
</div>
</div>
<div id="implicit-variables" class="section level2 hasAnchor" number="4.6">
<h2 class="hasAnchor"><span class="header-section-number">4.6</span> Implicit variables<a href="#implicit-variables" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Implicit variables in Nextflow are a set of variables that are automatically defined by Nextflow for a process, globally, or in <code>nextflow.config</code>.
They can be accessed to modify the execution of processes and workflows according to their value.</p>
<p>Here just a few implicit variables are presented. For a full description visit <a href="https://www.nextflow.io/docs/latest/script.html#implicit-variables">here</a>.</p>
<div id="script-implicit-variables-available-in-main.nf" class="section level3 hasAnchor" number="4.6.1">
<h3 class="hasAnchor"><span class="header-section-number">4.6.1</span> Script implicit variables (available in <code>main.nf</code>)<a href="#script-implicit-variables-available-in-main.nf" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li><code>projectDir</code>: the directory where the <code>main.nf</code> script is located</li>
<li><code>launchDir</code>: the directory where Nextflow is executed from</li>
<li><code>params</code>: a dictionary containing parameters given via the command line or via <code>nextflow.config</code> (like <code>params.input</code> that we used in the basic section of this workshop)</li>
<li><code>workDir</code>: the working directory where the processes are executed</li>
</ul>
</div>
<div id="configuration-implicit-variables-available-in-nextflow.config" class="section level3 hasAnchor" number="4.6.2">
<h3 class="hasAnchor"><span class="header-section-number">4.6.2</span> Configuration implicit variables (available in <code>nextflow.config</code>)<a href="#configuration-implicit-variables-available-in-nextflow.config" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li><code>launchDir</code>: the directory where Nextflow is executed from</li>
<li><code>projectDir</code>: the directory where the <code>main.nf</code> script is located</li>
</ul>
</div>
<div id="process-implicit-variables-defined-within-a-process" class="section level3 hasAnchor" number="4.6.3">
<h3 class="hasAnchor"><span class="header-section-number">4.6.3</span> Process implicit variables (defined within a process)<a href="#process-implicit-variables-defined-within-a-process" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>All of the process implicit variables are part of the <code>task</code> dictionary.</p>
<ul>
<li><code>task.attempt</code>: the number of times the task has been retried because of errors (when using <code>errorStrategy "retry"</code>)</li>
<li><code>task.hash</code>: the hash values of the taks used to define its working directory</li>
<li><code>task.processes</code>: the name of the process</li>
<li><code>task.name</code>: the name of the task (composed of process name and inputs)</li>
<li><code>task.exitStatus</code>: the exit code of the task</li>
</ul>
</div>
</div>
<div id="directives" class="section level2 hasAnchor" number="4.7">
<h2 class="hasAnchor"><span class="header-section-number">4.7</span> Directives<a href="#directives" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Directives are options that can be applied to processes, affecting their execution in several ways.
We already saw the <code>conda</code>, <code>container</code>, <code>cpu</code>, <code>time</code>, and <code>memory</code> directives in the basic section of this workshop.
Here we will explore them more in detail, together with some additional directives that we did not encounter before.</p>
<p>This list is not exhaustive. For a complete description of Nextflow directives see <a href="https://www.nextflow.io/docs/latest/process.html#directives">here</a>.</p>
<div id="the-conda-directive" class="section level3 hasAnchor" number="4.7.1">
<h3 class="hasAnchor"><span class="header-section-number">4.7.1</span> The <code>conda</code> directive<a href="#the-conda-directive" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>conda</code> directive is used to define a conda environment where the script block is run.
Even when using the faster <code>mamba</code> solver instead than <code>conda</code>, still the <code>conda</code> directive is used to specify the dependencies.</p>
<pre><code>process {
  conda &quot;python pandas&quot;

  script:
    &quot;&quot;&quot;
    &quot;&quot;&quot;
}</code></pre>
</div>
<div id="the-container-directive" class="section level3 hasAnchor" number="4.7.2">
<h3 class="hasAnchor"><span class="header-section-number">4.7.2</span> The <code>container</code> directive<a href="#the-container-directive" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>container</code> directive defines the container used to run the script block.
This can be a Docker container, a Singularity container, or other kinds of containers (see <a href="https://www.nextflow.io/docs/latest/container.html">here</a> for more).
The container runtime to be used is usually defined in defined in the <code>nextflow.config</code> file.
The container can be local or hosted in a container registry like DockerHub.</p>
<pre><code>process {
  container &quot;docker://saulpierottiebi/nvtop&quot;

  script:
    &quot;&quot;&quot;
    &quot;&quot;&quot;
}</code></pre>
</div>
<div id="the-cpus-memory-and-time-directives" class="section level3 hasAnchor" number="4.7.3">
<h3 class="hasAnchor"><span class="header-section-number">4.7.3</span> The <code>cpus</code>, <code>memory</code>, and <code>time</code> directives<a href="#the-cpus-memory-and-time-directives" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>cpus</code>, <code>memory</code>, and <code>time</code> directives are used to define the resources required by a process.
These are used for example when scheduling jobs with a batch scheduler in a cluster environment.
They are able to understand both strings (like <code>"1 GB"</code>, or <code>"2 days"</code>) and also values in the form <code>1.GB</code> or <code>1.day</code>.
The latter expression can also be used in closures to dynamically compute resource requirements (for example, <code>memory { 2.GB * task.attempt }</code>, we will see this better when talking of the <code>errorStrategy</code> directive).</p>
<pre><code>process {
  cpus 4
  memory &quot;1 GB&quot;
  time &quot;2 days&quot;

  script:
    &quot;&quot;&quot;
    &quot;&quot;&quot;
}</code></pre>
</div>
<div id="the-label-directive" class="section level3 hasAnchor" number="4.7.4">
<h3 class="hasAnchor"><span class="header-section-number">4.7.4</span> The <code>label</code> directive<a href="#the-label-directive" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>label</code> directive is used to apply a common set of configurations to a set of processes.
This allows all the configurations to be defined centrally in <code>nextflow.config</code>, instead than being hard-coded in each process definition.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>process do_something <span class="op">{</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  label <span class="st">&quot;process_long&quot;</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>  script<span class="op">:</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>process do_something_else <span class="op">{</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>  label <span class="st">&quot;process_long&quot;</span></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>  script<span class="op">:</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Any process directive can be included in the <code>withLabel</code> code block in <code>nextflow.config</code>.</p>
<p>And in <code>nextflow.config</code>:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>withLabel<span class="op">:</span>process_long <span class="op">{</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  time <span class="op">=</span> <span class="st">&quot;3 days&quot;</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="the-debug-directive" class="section level3 hasAnchor" number="4.7.5">
<h3 class="hasAnchor"><span class="header-section-number">4.7.5</span> The <code>debug</code> directive<a href="#the-debug-directive" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>debug</code> directive can be set to the boolean values <code>true</code> or <code>false</code>.
If set to <code>true</code>, the standard output of the process is shown on the command line during workflows execution.
As the name suggests, this is useful for debugging particular processes.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>process do_something <span class="op">{</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  debug <span class="kw">true</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>  script<span class="op">:</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a><span class="st">    echo &quot;This will be seen in the console&quot;</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="the-cache-directive" class="section level3 hasAnchor" number="4.7.6">
<h3 class="hasAnchor"><span class="header-section-number">4.7.6</span> The <code>cache</code> directive<a href="#the-cache-directive" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>cache</code> directive controls the behaviour of the Nextflow resume system.
If cache is set to <code>false</code>, the process is not cached and it is executed <em>de novo</em> each time, even if <code>resume</code> is set to <code>true</code> globally.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>process do_something <span class="op">{</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  cache <span class="kw">false</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  script<span class="op">:</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="the-errorstrategy-directive" class="section level3 hasAnchor" number="4.7.7">
<h3 class="hasAnchor"><span class="header-section-number">4.7.7</span> The <code>errorStrategy</code> directive<a href="#the-errorstrategy-directive" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>errorStrategy</code> directive controls what happens when the exit code of a process is not <code>0</code> (when the process terminates with an error).
Possible values are “terminate”, “retry”, “finish”, and “ignore”.</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>process do_something <span class="op">{</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  errorStrategy <span class="st">&quot;ignore&quot;</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  script<span class="op">:</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>It is also possible to use a closure as an argument for the <code>errorStrategy</code> directive.
This allows to obtain a different behaviour with different exit codes.
Combining the “retry” <code>errorStrategy</code> with dynamic resource allocation we can obtain a process that when fails with certain exit codes (for example corresponding to insufficient memory) is retried with more resources.</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>process do_something <span class="op">{</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  errorStrategy <span class="op">{</span> task<span class="op">.</span>exitStatus <span class="op">==</span> <span class="dv">130</span> <span class="op">?</span> <span class="st">&quot;retry&quot;</span> <span class="op">:</span> <span class="st">&quot;terminate&quot;</span> <span class="op">}</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  memory <span class="op">{</span> <span class="fl">10.G</span>B <span class="op">*</span> task<span class="op">.</span>attempt <span class="op">}</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>  script<span class="op">:</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Note that the exit codes are platform-dependent so are best defined on a platform dependent basis instead than being hard-coded.</p>
</div>
<div id="the-publishdir-directive" class="section level3 hasAnchor" number="4.7.8">
<h3 class="hasAnchor"><span class="header-section-number">4.7.8</span> The <code>publishDir</code> directive<a href="#the-publishdir-directive" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>publishDir</code> directive defines where to copy the outputs of a process following successful execution.
This is typically used with the final outputs of a workflow that are of interest for further analysis.
Using the <code>publishDir</code> directory, we can obtain all our outputs in a organised directory structure.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>process do_something <span class="op">{</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>  publishDir <span class="st">&quot;/my/output/dir&quot;</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  output<span class="op">:</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    path <span class="st">&quot;my_file.txt&quot;</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>  script<span class="op">:</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a><span class="st">    touch my_file.txt</span></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="the-executor-and-queue-directives" class="section level3 hasAnchor" number="4.7.9">
<h3 class="hasAnchor"><span class="header-section-number">4.7.9</span> The <code>executor</code> and <code>queue</code> directives<a href="#the-executor-and-queue-directives" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>executor</code> directive allows to specify the executor to use for a given process.
This can be “local” (the default) for local execution, “lsf” for using the batch scheduler <a href="https://www.ibm.com/docs/en/spectrum-lsf">IBM Spectrum LSF</a>, or other values for several other batch schedulers.
It is even possible to use cloud infrastructures such as <a href="https://aws.amazon.com/?nc2=h_lg">AWS</a>, <a href="https://azure.microsoft.com/en-gb/">Microsoft Azure</a>, or <a href="https://cloud.google.com/">Google Cloud</a>.</p>
<p>Using executors other than the “local” executor is essential for real-world workflows, where the computational resources required often vastly exceed those of a single laptop or even server.</p>
<p>You can read more about different executors for Nextflow <a href="https://www.nextflow.io/docs/latest/executor.html#">here</a>.</p>
<p>The <code>queue</code> directive allows you to define which of the batch scheduler queues to submit the process’ tasks to.
The value assigned to the <code>queue</code> directive should be a string matching the name of an existing queue.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>process do_something <span class="op">{</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  executor <span class="st">&quot;lsf&quot;</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>  queue <span class="st">&quot;research&quot;</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>  script<span class="op">:</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="the-ext-directive" class="section level3 hasAnchor" number="4.7.10">
<h3 class="hasAnchor"><span class="header-section-number">4.7.10</span> The <code>ext</code> directive<a href="#the-ext-directive" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>ext</code> directive is used for advanced, custom configurations.
It allows you to define any key-value pair for the process.
The argument of the <code>ext</code> directive should be a closure assigning a variable.
The custom variables are made available like any other <code>task</code> implicit variable in the dictionary <code>task.ext</code>.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>process do_something <span class="op">{</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>  ext <span class="op">{</span> my_var <span class="op">=</span> <span class="st">&quot;my_value&quot;</span> <span class="op">}</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  script<span class="op">:</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a><span class="st">    echo </span><span class="ss">$task</span><span class="op">.</span><span class="ss">ext</span><span class="op">.</span><span class="ss">my_var</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div id="advanced-workflow-configuration" class="section level2 hasAnchor" number="4.8">
<h2 class="hasAnchor"><span class="header-section-number">4.8</span> Advanced workflow configuration<a href="#advanced-workflow-configuration" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We have already explored one of the main locations where Nextflow configurations can be set: the <code>nextflow.config</code> file.
Nextflow actually provides several systems for configuring a workflow, each suited to a specific use-case.
We will explore them in this section, together with configuration profiles.</p>
<div id="configuration-files-and-command-line-parameters" class="section level3 hasAnchor" number="4.8.1">
<h3 class="hasAnchor"><span class="header-section-number">4.8.1</span> Configuration files and command line parameters<a href="#configuration-files-and-command-line-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Configuration files can be found in canonical locations, that Nextflow checks automatically.
Alternatively, it is possible to manually load a configuration file in a custom location when running a workflow, or pass configuration parameters on the command line itself.</p>
<p>A rigid hierarchy of configurations applies, so that in case of conflicting configurations it is predictable which one will be actually used.
The following configuration modes go from highest to lowest priority:</p>
<ul>
<li>Command line parameters (<code>--some_param</code>)</li>
<li>Parameters provided in a file via the <code>-params-file</code> option</li>
<li>Manually sourced configuration files via the <code>-c</code> option</li>
<li>The <code>nextflow.config</code> file in the current directory</li>
<li>The <code>nextflow.config</code> file in the project directory</li>
<li>The <code>$HOME/.nextflow/config</code> file</li>
<li>Values defined in the pipeline script itself (i.e. <code>main.nf</code>)</li>
</ul>
<div id="command-line-parameters" class="section level4 hasAnchor" number="4.8.1.1">
<h4 class="hasAnchor"><span class="header-section-number">4.8.1.1</span> Command line parameters<a href="#command-line-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Any parameter passed on the command line with a double dash (<code>--some_param</code>) is loaded in the <code>params</code> scope in Nextflow (so <code>--some_param 4</code> will assigning a value of 4 to the variable <code>params.some_param</code>).
If a value is specified after the command line flag (for example <code>--some_param 4</code>), the value is assigned to the parameter.
If no value is specified (for example <code>--some_param</code>), the variable will store the boolean value <code>true</code>.
Since command line parameters have the highest priority in the configuration hierarchy, they are often used to override default parameter values set in <code>nextflow.config</code>.</p>
<p>It is important to differentiate workflow command line parameters that are prepended by a double dash <code>--some_param</code> from Nextflow runtime parameters which are prepended by a single dash (<code>-resume</code>).
Nextflow runtime parameters are used to modify the behaviour of Nextflow itself and do not affect the parameter space of the workflow.</p>
</div>
<div id="the-nextflow.config-file" class="section level4 hasAnchor" number="4.8.1.2">
<h4 class="hasAnchor"><span class="header-section-number">4.8.1.2</span> The <code>nextflow.config</code> file<a href="#the-nextflow.config-file" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This file is automatically sourced by Nextflow and should be placed in the same directory as <code>main.nf</code> (another <code>nextflow.config</code> file can also be present in the launch directory, but this is rarely used in my experience).
It is typically used to set workflow-specific configurations that do not depend on the compute environment where the workflow is run, nor on the specific inputs used.</p>
<p>For example, the <code>nextflow.config</code> file can be used to set process software dependencies with a <code>withLabel</code> code block.
Another typically usage is that of setting default values for parameters that can be overridden on the command line (as part of a <code>params</code> block).
Profiles corresponding to different use-case scenarios are also often included.</p>
</div>
<div id="the-home.nextflowconfig-file" class="section level4 hasAnchor" number="4.8.1.3">
<h4 class="hasAnchor"><span class="header-section-number">4.8.1.3</span> The <code>$HOME/.nextflow/config</code> file<a href="#the-home.nextflowconfig-file" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The <code>$HOME/.nextflow/config</code> file is typically used for compute environment-specific configurations, since it is available to all the workflows run on a given system.</p>
<p>So for example we may want our workflows to behave differently on our local laptop versus on a high performance cluster.
On my own <code>$HOME/.nextflow/config</code> on the EBI cluster, I define for example when different queues should be used, I set the executor to IBM Spectrum LSF, and I set the path for the input and output directories.</p>
</div>
<div id="custom-configuration-files" class="section level4 hasAnchor" number="4.8.1.4">
<h4 class="hasAnchor"><span class="header-section-number">4.8.1.4</span> Custom configuration files<a href="#custom-configuration-files" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Custom configuration files can be provided via the <code>-c config_file_path</code> option or via the <code>-params-file params_file_path</code> option on the command line.
They have a similar use case to command-line parameters, but they are easier to use when several parameters have to be overridden at once.</p>
</div>
<div id="parameters-hard-coded-in-the-nextflow-script" class="section level4 hasAnchor" number="4.8.1.5">
<h4 class="hasAnchor"><span class="header-section-number">4.8.1.5</span> Parameters hard-coded in the Nextflow script<a href="#parameters-hard-coded-in-the-nextflow-script" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>It is also possible to hard-code parameters in the Nextflow script itself (i.e. in <code>main.nf</code>).
This can be used to achieve more complex configurations with conditional statements.
Note that parameters set in this way have the lowest priority.</p>
</div>
</div>
<div id="configuration-profiles" class="section level3 hasAnchor" number="4.8.2">
<h3 class="hasAnchor"><span class="header-section-number">4.8.2</span> Configuration profiles<a href="#configuration-profiles" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Configuration profiles are set of configurations that have a collective name and can be optionally activated on the command line.
They can be written in any of the configuration files we explored before.
The following code defines a configuration profiles named <code>cluster</code>.</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>profiles <span class="op">{</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  cluster <span class="op">{</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>    executor<span class="op">.</span>name <span class="op">=</span> <span class="st">&quot;lsf&quot;</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>    executor<span class="op">.</span>queueSize <span class="op">=</span> <span class="dv">500</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    executor<span class="op">.</span>submitRateLimit <span class="op">=</span> <span class="st">&quot;10/1sec&quot;</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>    executor<span class="op">.</span>exitReadTimeout <span class="op">=</span> <span class="st">&quot;30 min&quot;</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This profile can be activated by passing the flag <code>-profile cluster</code> on the command line.
Once activated, all the configurations contained in it are applied.
Several profiles can be defined in the <code>profiles</code> block.
If several profiles need to be activated at the same time, this can be done by concatenating them with commas after the <code>-profile</code> option (so if the profiles <code>foo</code> and <code>bar</code> need to be activated at once, I can write <code>-profile foo,bar</code>).</p>
<p>Profiles are particularly useful to set compute environments, software environments (i.e. use conda versus Docker versus Singularity), and particular running modes (think of a workflow that can perform several things, and the profile is used to choose what the workflow should do).</p>
</div>
</div>
<div id="sub-workflows" class="section level2 hasAnchor" number="4.9">
<h2 class="hasAnchor"><span class="header-section-number">4.9</span> Sub-workflows<a href="#sub-workflows" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Sub-workflows can be used to modularise a workflow in logic steps.
So for example a workflow that does germline variant calling on a set of sequencing files can be composed of a sub-workflow that maps the sequencing files to a reference and a sub-workflow that does the variant calling from the mapped sequencing files.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>processes defined here<span class="op">&gt;</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>workflow MAP_TO_REF <span class="op">{</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>  input<span class="op">:</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    fastq_ch</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>  main<span class="op">:</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">run_bwamem2</span><span class="op">(</span> fastq_ch <span class="op">)</span></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mark_duplicates</span><span class="op">(</span> run_bwamem2<span class="op">.</span>out <span class="op">)</span></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>  output<span class="op">:</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>    mark_duplicates<span class="op">.</span>out</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>workflow CALL_VARIANTS <span class="op">{</span></span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>  input<span class="op">:</span></span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>    mapped_crams_ch</span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>  main<span class="op">:</span></span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gatk_haplotypecaller</span><span class="op">(</span> mapped_crams_ch <span class="op">)</span></span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">genomics_db_import</span><span class="op">(</span> gatk_haplotypecaller<span class="op">.</span>out <span class="op">)</span></span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gatk_genotypegvcfs</span><span class="op">(</span> genomics_db_import<span class="op">.</span>out <span class="op">)</span></span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a>  output<span class="op">:</span></span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a>    gatk_genotypegvcfs<span class="op">.</span>out</span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-24"><a href="#cb111-24" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb111-25"><a href="#cb111-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MAP_TO_REF</span><span class="op">(</span> params<span class="op">.</span>input <span class="op">)</span></span>
<span id="cb111-26"><a href="#cb111-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CALL_VARIANTS</span><span class="op">(</span> MAP_TO_REF<span class="op">.</span>out <span class="op">)</span></span>
<span id="cb111-27"><a href="#cb111-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Sub-workflows can have an <code>input</code>, a <code>main</code>,and a <code>output</code> block.
The <code>input</code> block defines the name of one or more channels that are passed as an input to the sub-workflows.
The <code>output</code> block can define a channel accessible from <code>&lt;WORKFLOW_NAME&gt;.out</code> after execution.
The <code>main</code> block defines the actual workflow logic in terms of processes to be run and channel manipulations.</p>
<p>It is also possible to write separate logical steps of the workflow in separate <code>.nf</code> files.
Such additional files can have any name and are usually put under the folder <code>workflows</code> in the project directory.
Workflows defined in such files can be accessed from <code>main.nf</code> using an <code>include</code> statement.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>include <span class="op">{</span> PRE_PROCESSING <span class="op">}</span> from <span class="st">&#39;./workflows/pre_processing&#39;</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>include <span class="op">{</span> DO_SOME_WORK <span class="op">}</span> from <span class="st">&#39;./workflows/important_script.nf&#39;</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">PRE_PROCESSING</span><span class="op">(</span> params<span class="op">.</span>input <span class="op">)</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">DO_SOME_WORK</span><span class="op">(</span> PRE_PROCESSING<span class="op">.</span>out <span class="op">)</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="nextflow-tower" class="section level2 hasAnchor" number="4.10">
<h2 class="hasAnchor"><span class="header-section-number">4.10</span> Nextflow Tower<a href="#nextflow-tower" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><a href="https://cloud.tower.nf/">Nextflow Tower</a> is a centralised web interface that allows to monitor and launch your Nextflow workflows.
It is possible to use the Nextflow Tower website (for free) or also on-premises solution are available for institutions (at a price).</p>
<p>Nextflow Tower communicates with the execution environment via <a href="https://www.wikiwand.com/en/Secure_Shell">SSH</a> access (if the host is reachable via SSH), or via a <a href="https://help.tower.nf/22.3/agent/">“Tower agent”</a> that is run on the execution environment itself.
Nextflow Tower is particularly useful when you are running several pipelines at the same time in different environments to monitor failures and resource usage.</p>
<p>You can have a look at an example of the Nextflow Tower interface here below.</p>
<p><img src="images/nextflow_tower.png" /></p>
</div>
</div>
<div id="advanced-challenge" class="section level1 hasAnchor" number="5">
<h1 class="hasAnchor"><span class="header-section-number">5</span> Advanced challenge<a href="#advanced-challenge" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>You are given a set of <a href="https://www.wikiwand.com/en/Tab-separated_values">tsv files</a>.
Each file contains a single column with the header “Entry” containing a set of <a href="https://www.uniprot.org/">UniProt</a> protein IDs belonging to a single species (different for each file).
You are given a sample sheet containing a list of animal species and the path to the tsv file containing UniProt IDs for that species.
Finally, you are given a csv file containing all the natural amino acids found in proteins with their one-letter codes, three-letter codes, common names, and whether they have a polar or apolar side chain.
Your goal is to produce a box plot showing, for each species, the distribution of the fraction of polar versus apolar amino acids (across the proteins provided).
You should produce a plot like the one following and place it in the folder <code>../nextflow_output/challange</code> (relative to your project directory).</p>
<p><img src="images/final_plot.png" /></p>
<p>Your input files will be created in the folder <code>../nextflow_inputs</code> (after running the commands in the <a href="#setup-1">Setup</a> section), and you can explore them manually to see their structure.
You may use any programming language for the task, but you should embed any computational step in a Nextflow process.
It is preferable if you split the work in as many independent processes as possible, instead than doing everything in a monolithic process.</p>
<p><strong>Hint:</strong> you can retrieve protein sequences from UniProt programmatically by running the following (replacing <code>&lt;uniprot-id&gt;</code> with the actual UniProt ID of the protein you want to download)</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://rest.uniprot.org/uniprotkb/<span class="op">&lt;</span>uniprot-id<span class="op">&gt;</span>.fasta</span></code></pre></div>
<div id="setup-1" class="section level2 hasAnchor" number="5.1">
<h2 class="hasAnchor"><span class="header-section-number">5.1</span> Setup<a href="#setup-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Create the required sample sheet file by running the following command from your project directory (make sure that the folder <code>../nextflow_inputs</code> exists before running the command)</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;filename,species&quot;</span> <span class="op">&gt;</span> ../nextflow_inputs/samplesheet.csv</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span><span class="st">/../nextflow_inputs/arabidopsis.tsv,Arabidopsis taliana&quot;</span> <span class="op">&gt;&gt;</span> ../nextflow_inputs/samplesheet.csv</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span><span class="st">/../nextflow_inputs/mouse.tsv,Mus musculus&quot;</span> <span class="op">&gt;&gt;</span> ../nextflow_inputs/samplesheet.csv</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span><span class="st">/../nextflow_inputs/zebrafish.tsv,Danio rerio&quot;</span> <span class="op">&gt;&gt;</span> ../nextflow_inputs/samplesheet.csv</span></code></pre></div>
<p>Download the required data files by running the following command (as before, make sure that the folder <code>../nextflow_inputs</code> exists before running the command)</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> <span class="at">-P</span> ../nextflow_inputs https://raw.githubusercontent.com/saulpierotti-ebi/saulpierotti-ebi.github.io/main/assets/arabidopsis.tsv</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> <span class="at">-P</span> ../nextflow_inputs https://raw.githubusercontent.com/saulpierotti-ebi/saulpierotti-ebi.github.io/main/assets/zebrafish.tsv</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> <span class="at">-P</span> ../nextflow_inputs https://raw.githubusercontent.com/saulpierotti-ebi/saulpierotti-ebi.github.io/main/assets/mouse.tsv</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> <span class="at">-P</span> ../nextflow_inputs https://raw.githubusercontent.com/saulpierotti-ebi/saulpierotti-ebi.github.io/main/assets/polar_apolar_table.csv</span></code></pre></div>
</div>
<div id="solution" class="section level2 hasAnchor" number="5.2">
<h2 class="hasAnchor"><span class="header-section-number">5.2</span> Solution<a href="#solution" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>You can see the solution to this challenge by expanding the following hidden sections.</p>
<details>
<summary>
Click here to see the solution (<code>main.nf</code> file)
</summary>
<div class="sourceCode" id="cb116"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>nextflow<span class="op">.</span>enable<span class="op">.</span>dsl <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>process get_sequences <span class="op">{</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tuple</span><span class="op">(</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">val</span><span class="op">(</span>species<span class="op">),</span></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">path</span><span class="op">(</span>id_list<span class="op">)</span></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tuple</span><span class="op">(</span></span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>            <span class="fu">val</span><span class="op">(</span>species<span class="op">),</span></span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a>            <span class="fu">path</span><span class="op">(</span><span class="st">&quot;*.fasta&quot;</span><span class="op">)</span></span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true" tabindex="-1"></a><span class="st">        cat </span><span class="ss">$id_list</span><span class="st"> </span><span class="er">\</span></span>
<span id="cb116-19"><a href="#cb116-19" aria-hidden="true" tabindex="-1"></a><span class="st">            | tail -n +2 </span><span class="er">\</span></span>
<span id="cb116-20"><a href="#cb116-20" aria-hidden="true" tabindex="-1"></a><span class="st">            | xargs -I{} wget https://rest.uniprot.org/uniprotkb/{}.fasta</span></span>
<span id="cb116-21"><a href="#cb116-21" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb116-22"><a href="#cb116-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb116-23"><a href="#cb116-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-24"><a href="#cb116-24" aria-hidden="true" tabindex="-1"></a>process count_aa <span class="op">{</span></span>
<span id="cb116-25"><a href="#cb116-25" aria-hidden="true" tabindex="-1"></a>    label <span class="st">&quot;r_tidyverse&quot;</span></span>
<span id="cb116-26"><a href="#cb116-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-27"><a href="#cb116-27" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb116-28"><a href="#cb116-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tuple</span><span class="op">(</span></span>
<span id="cb116-29"><a href="#cb116-29" aria-hidden="true" tabindex="-1"></a>            <span class="fu">val</span><span class="op">(</span>protein<span class="op">),</span></span>
<span id="cb116-30"><a href="#cb116-30" aria-hidden="true" tabindex="-1"></a>            <span class="fu">val</span><span class="op">(</span>species<span class="op">),</span></span>
<span id="cb116-31"><a href="#cb116-31" aria-hidden="true" tabindex="-1"></a>            <span class="fu">path</span><span class="op">(</span>sequence<span class="op">)</span></span>
<span id="cb116-32"><a href="#cb116-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb116-33"><a href="#cb116-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-34"><a href="#cb116-34" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb116-35"><a href="#cb116-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tuple</span><span class="op">(</span></span>
<span id="cb116-36"><a href="#cb116-36" aria-hidden="true" tabindex="-1"></a>            <span class="fu">val</span><span class="op">(</span>protein<span class="op">),</span></span>
<span id="cb116-37"><a href="#cb116-37" aria-hidden="true" tabindex="-1"></a>            <span class="fu">val</span><span class="op">(</span>species<span class="op">),</span></span>
<span id="cb116-38"><a href="#cb116-38" aria-hidden="true" tabindex="-1"></a>            <span class="fu">path</span><span class="op">(</span><span class="st">&quot;</span><span class="ss">${</span>sequence<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.aa_counts.csv&quot;</span><span class="op">)</span></span>
<span id="cb116-39"><a href="#cb116-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb116-40"><a href="#cb116-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-41"><a href="#cb116-41" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb116-42"><a href="#cb116-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb116-43"><a href="#cb116-43" aria-hidden="true" tabindex="-1"></a><span class="st">        #!/usr/bin/env Rscript</span></span>
<span id="cb116-44"><a href="#cb116-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-45"><a href="#cb116-45" aria-hidden="true" tabindex="-1"></a><span class="st">        library(&quot;tidyverse&quot;)</span></span>
<span id="cb116-46"><a href="#cb116-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-47"><a href="#cb116-47" aria-hidden="true" tabindex="-1"></a><span class="st">        df &lt;- read_lines(&quot;</span><span class="ss">${</span>sequence<span class="ss">}</span><span class="st">&quot;, skip=1) %&gt;%</span></span>
<span id="cb116-48"><a href="#cb116-48" aria-hidden="true" tabindex="-1"></a><span class="st">            paste(collapse = &#39;&#39;) %&gt;%</span></span>
<span id="cb116-49"><a href="#cb116-49" aria-hidden="true" tabindex="-1"></a><span class="st">            strsplit(split = &#39;&#39;) %&gt;%</span></span>
<span id="cb116-50"><a href="#cb116-50" aria-hidden="true" tabindex="-1"></a><span class="st">            table() %&gt;%</span></span>
<span id="cb116-51"><a href="#cb116-51" aria-hidden="true" tabindex="-1"></a><span class="st">            as_tibble() %&gt;%</span></span>
<span id="cb116-52"><a href="#cb116-52" aria-hidden="true" tabindex="-1"></a><span class="st">            rename(residue = &quot;.&quot;) %&gt;%</span></span>
<span id="cb116-53"><a href="#cb116-53" aria-hidden="true" tabindex="-1"></a><span class="st">            mutate(</span></span>
<span id="cb116-54"><a href="#cb116-54" aria-hidden="true" tabindex="-1"></a><span class="st">                freq = n / sum(n),</span></span>
<span id="cb116-55"><a href="#cb116-55" aria-hidden="true" tabindex="-1"></a><span class="st">                protein = &quot;</span><span class="ss">${</span>protein<span class="ss">}</span><span class="st">&quot;,</span></span>
<span id="cb116-56"><a href="#cb116-56" aria-hidden="true" tabindex="-1"></a><span class="st">                species = &quot;</span><span class="ss">${</span>species<span class="ss">}</span><span class="st">&quot;</span></span>
<span id="cb116-57"><a href="#cb116-57" aria-hidden="true" tabindex="-1"></a><span class="st">            )</span></span>
<span id="cb116-58"><a href="#cb116-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-59"><a href="#cb116-59" aria-hidden="true" tabindex="-1"></a><span class="st">        write_csv(df, &quot;</span><span class="ss">${</span>sequence<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.aa_counts.csv&quot;)</span></span>
<span id="cb116-60"><a href="#cb116-60" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb116-61"><a href="#cb116-61" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb116-62"><a href="#cb116-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-63"><a href="#cb116-63" aria-hidden="true" tabindex="-1"></a>process count_by_polarity <span class="op">{</span></span>
<span id="cb116-64"><a href="#cb116-64" aria-hidden="true" tabindex="-1"></a>    label <span class="st">&quot;r_tidyverse&quot;</span></span>
<span id="cb116-65"><a href="#cb116-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-66"><a href="#cb116-66" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb116-67"><a href="#cb116-67" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tuple</span><span class="op">(</span></span>
<span id="cb116-68"><a href="#cb116-68" aria-hidden="true" tabindex="-1"></a>            <span class="fu">val</span><span class="op">(</span>protein<span class="op">),</span></span>
<span id="cb116-69"><a href="#cb116-69" aria-hidden="true" tabindex="-1"></a>            <span class="fu">val</span><span class="op">(</span>species<span class="op">),</span></span>
<span id="cb116-70"><a href="#cb116-70" aria-hidden="true" tabindex="-1"></a>            <span class="fu">path</span><span class="op">(</span>aa_counts<span class="op">),</span></span>
<span id="cb116-71"><a href="#cb116-71" aria-hidden="true" tabindex="-1"></a>            <span class="fu">path</span><span class="op">(</span>polar_apolar_table<span class="op">)</span></span>
<span id="cb116-72"><a href="#cb116-72" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb116-73"><a href="#cb116-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-74"><a href="#cb116-74" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb116-75"><a href="#cb116-75" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tuple</span><span class="op">(</span></span>
<span id="cb116-76"><a href="#cb116-76" aria-hidden="true" tabindex="-1"></a>            <span class="fu">val</span><span class="op">(</span>protein<span class="op">),</span></span>
<span id="cb116-77"><a href="#cb116-77" aria-hidden="true" tabindex="-1"></a>            <span class="fu">val</span><span class="op">(</span>species<span class="op">),</span></span>
<span id="cb116-78"><a href="#cb116-78" aria-hidden="true" tabindex="-1"></a>            <span class="fu">path</span><span class="op">(</span><span class="st">&quot;</span><span class="ss">${</span>aa_counts<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.polarity_counts.csv&quot;</span><span class="op">)</span></span>
<span id="cb116-79"><a href="#cb116-79" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb116-80"><a href="#cb116-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-81"><a href="#cb116-81" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb116-82"><a href="#cb116-82" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb116-83"><a href="#cb116-83" aria-hidden="true" tabindex="-1"></a><span class="st">        #!/usr/bin/env Rscript</span></span>
<span id="cb116-84"><a href="#cb116-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-85"><a href="#cb116-85" aria-hidden="true" tabindex="-1"></a><span class="st">        library(&quot;tidyverse&quot;)</span></span>
<span id="cb116-86"><a href="#cb116-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-87"><a href="#cb116-87" aria-hidden="true" tabindex="-1"></a><span class="st">        pol_table &lt;- read_csv(&quot;</span><span class="ss">${</span>polar_apolar_table<span class="ss">}</span><span class="st">&quot;) %&gt;%</span></span>
<span id="cb116-88"><a href="#cb116-88" aria-hidden="true" tabindex="-1"></a><span class="st">            summarise(</span></span>
<span id="cb116-89"><a href="#cb116-89" aria-hidden="true" tabindex="-1"></a><span class="st">                residue = single_letter_code,</span></span>
<span id="cb116-90"><a href="#cb116-90" aria-hidden="true" tabindex="-1"></a><span class="st">                polarity</span></span>
<span id="cb116-91"><a href="#cb116-91" aria-hidden="true" tabindex="-1"></a><span class="st">            )</span></span>
<span id="cb116-92"><a href="#cb116-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-93"><a href="#cb116-93" aria-hidden="true" tabindex="-1"></a><span class="st">        df &lt;- read_csv(&quot;</span><span class="ss">${</span>aa_counts<span class="ss">}</span><span class="st">&quot;) %&gt;%</span></span>
<span id="cb116-94"><a href="#cb116-94" aria-hidden="true" tabindex="-1"></a><span class="st">            left_join(pol_table) %&gt;%</span></span>
<span id="cb116-95"><a href="#cb116-95" aria-hidden="true" tabindex="-1"></a><span class="st">            group_by(polarity, species, protein) %&gt;%</span></span>
<span id="cb116-96"><a href="#cb116-96" aria-hidden="true" tabindex="-1"></a><span class="st">            summarise(freq = sum(freq))</span></span>
<span id="cb116-97"><a href="#cb116-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-98"><a href="#cb116-98" aria-hidden="true" tabindex="-1"></a><span class="st">        write_csv(df, &quot;</span><span class="ss">${</span>aa_counts<span class="op">.</span>simpleName<span class="ss">}</span><span class="st">.polarity_counts.csv&quot;)</span></span>
<span id="cb116-99"><a href="#cb116-99" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb116-100"><a href="#cb116-100" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb116-101"><a href="#cb116-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-102"><a href="#cb116-102" aria-hidden="true" tabindex="-1"></a>process aggregate_results <span class="op">{</span></span>
<span id="cb116-103"><a href="#cb116-103" aria-hidden="true" tabindex="-1"></a>    label <span class="st">&quot;r_tidyverse&quot;</span></span>
<span id="cb116-104"><a href="#cb116-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-105"><a href="#cb116-105" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb116-106"><a href="#cb116-106" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;*.csv&quot;</span></span>
<span id="cb116-107"><a href="#cb116-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-108"><a href="#cb116-108" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb116-109"><a href="#cb116-109" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;aggregated_polarity_counts.csv&quot;</span></span>
<span id="cb116-110"><a href="#cb116-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-111"><a href="#cb116-111" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb116-112"><a href="#cb116-112" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb116-113"><a href="#cb116-113" aria-hidden="true" tabindex="-1"></a><span class="st">        #!/usr/bin/env Rscript</span></span>
<span id="cb116-114"><a href="#cb116-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-115"><a href="#cb116-115" aria-hidden="true" tabindex="-1"></a><span class="st">        library(&quot;tidyverse&quot;)</span></span>
<span id="cb116-116"><a href="#cb116-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-117"><a href="#cb116-117" aria-hidden="true" tabindex="-1"></a><span class="st">        input_files &lt;- list.files(pattern = &quot;*.csv&quot;)</span></span>
<span id="cb116-118"><a href="#cb116-118" aria-hidden="true" tabindex="-1"></a><span class="st">        df &lt;- map_dfr(input_files, read_csv)</span></span>
<span id="cb116-119"><a href="#cb116-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-120"><a href="#cb116-120" aria-hidden="true" tabindex="-1"></a><span class="st">        write_csv(df, &quot;aggregated_polarity_counts.csv&quot;)</span></span>
<span id="cb116-121"><a href="#cb116-121" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb116-122"><a href="#cb116-122" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb116-123"><a href="#cb116-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-124"><a href="#cb116-124" aria-hidden="true" tabindex="-1"></a>process make_plot <span class="op">{</span></span>
<span id="cb116-125"><a href="#cb116-125" aria-hidden="true" tabindex="-1"></a>    label <span class="st">&quot;r_tidyverse&quot;</span></span>
<span id="cb116-126"><a href="#cb116-126" aria-hidden="true" tabindex="-1"></a>    publishDir <span class="st">&quot;../nextflow_output/challenge&quot;</span></span>
<span id="cb116-127"><a href="#cb116-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-128"><a href="#cb116-128" aria-hidden="true" tabindex="-1"></a>    input<span class="op">:</span></span>
<span id="cb116-129"><a href="#cb116-129" aria-hidden="true" tabindex="-1"></a>        path aggregated_polarity_counts</span>
<span id="cb116-130"><a href="#cb116-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-131"><a href="#cb116-131" aria-hidden="true" tabindex="-1"></a>    output<span class="op">:</span></span>
<span id="cb116-132"><a href="#cb116-132" aria-hidden="true" tabindex="-1"></a>        path <span class="st">&quot;final_plot.pdf&quot;</span></span>
<span id="cb116-133"><a href="#cb116-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-134"><a href="#cb116-134" aria-hidden="true" tabindex="-1"></a>    script<span class="op">:</span></span>
<span id="cb116-135"><a href="#cb116-135" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb116-136"><a href="#cb116-136" aria-hidden="true" tabindex="-1"></a><span class="st">        #!/usr/bin/env Rscript</span></span>
<span id="cb116-137"><a href="#cb116-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-138"><a href="#cb116-138" aria-hidden="true" tabindex="-1"></a><span class="st">        library(&quot;tidyverse&quot;)</span></span>
<span id="cb116-139"><a href="#cb116-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-140"><a href="#cb116-140" aria-hidden="true" tabindex="-1"></a><span class="st">        df &lt;- read_csv(&quot;</span><span class="ss">${</span>aggregated_polarity_counts<span class="ss">}</span><span class="st">&quot;)</span></span>
<span id="cb116-141"><a href="#cb116-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-142"><a href="#cb116-142" aria-hidden="true" tabindex="-1"></a><span class="st">        ggplot(df, aes(x=species, y=freq, color=polarity)) +</span></span>
<span id="cb116-143"><a href="#cb116-143" aria-hidden="true" tabindex="-1"></a><span class="st">            geom_boxplot()</span></span>
<span id="cb116-144"><a href="#cb116-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-145"><a href="#cb116-145" aria-hidden="true" tabindex="-1"></a><span class="st">        ggsave(&quot;final_plot.pdf&quot;)</span></span>
<span id="cb116-146"><a href="#cb116-146" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span></span>
<span id="cb116-147"><a href="#cb116-147" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb116-148"><a href="#cb116-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-149"><a href="#cb116-149" aria-hidden="true" tabindex="-1"></a>workflow <span class="op">{</span></span>
<span id="cb116-150"><a href="#cb116-150" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Channel</span><span class="op">.</span><span class="fu">fromPath</span><span class="op">(</span> params<span class="op">.</span>samplesheet <span class="op">).</span><span class="fu">splitCsv</span><span class="op">(</span> header<span class="op">:</span> <span class="kw">true</span> <span class="op">).</span><span class="fu">set</span><span class="op">{</span> input_ch <span class="op">}</span></span>
<span id="cb116-151"><a href="#cb116-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-152"><a href="#cb116-152" aria-hidden="true" tabindex="-1"></a>    input_ch<span class="op">.</span><span class="fu">map</span><span class="op">{</span> <span class="op">[</span> it<span class="op">[</span><span class="st">&quot;species&quot;</span><span class="op">],</span> it<span class="op">[</span><span class="st">&quot;filename&quot;</span><span class="op">]</span> <span class="op">]</span> <span class="op">}</span></span>
<span id="cb116-153"><a href="#cb116-153" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">set</span><span class="op">{</span> get_sequences_in_ch <span class="op">}</span></span>
<span id="cb116-154"><a href="#cb116-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-155"><a href="#cb116-155" aria-hidden="true" tabindex="-1"></a>    <span class="fu">get_sequences</span><span class="op">(</span> get_sequences_in_ch <span class="op">)</span></span>
<span id="cb116-156"><a href="#cb116-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-157"><a href="#cb116-157" aria-hidden="true" tabindex="-1"></a>    get_sequences<span class="op">.</span>out</span>
<span id="cb116-158"><a href="#cb116-158" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">flatMap</span><span class="op">{</span></span>
<span id="cb116-159"><a href="#cb116-159" aria-hidden="true" tabindex="-1"></a>            <span class="dt">def</span> species <span class="op">=</span> it<span class="op">[</span><span class="dv">0</span><span class="op">]</span></span>
<span id="cb116-160"><a href="#cb116-160" aria-hidden="true" tabindex="-1"></a>            <span class="dt">def</span> all_sequences <span class="op">=</span> it<span class="op">[</span><span class="dv">1</span><span class="op">]</span></span>
<span id="cb116-161"><a href="#cb116-161" aria-hidden="true" tabindex="-1"></a>            all_sequences<span class="op">.</span><span class="fu">collect</span><span class="op">{</span> sequence <span class="op">-&gt;</span> <span class="op">[</span>species<span class="op">,</span> sequence<span class="op">]</span> <span class="op">}</span></span>
<span id="cb116-162"><a href="#cb116-162" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb116-163"><a href="#cb116-163" aria-hidden="true" tabindex="-1"></a>        <span class="co">// add the sequence name as a value</span></span>
<span id="cb116-164"><a href="#cb116-164" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">map</span><span class="op">{</span> <span class="op">[</span> it<span class="op">[</span><span class="dv">1</span><span class="op">].</span>simpleName <span class="op">]</span> <span class="op">+</span> it <span class="op">}</span></span>
<span id="cb116-165"><a href="#cb116-165" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">set</span><span class="op">{</span> count_aa_in_ch <span class="op">}</span></span>
<span id="cb116-166"><a href="#cb116-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-167"><a href="#cb116-167" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count_aa</span><span class="op">(</span> count_aa_in_ch <span class="op">)</span></span>
<span id="cb116-168"><a href="#cb116-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-169"><a href="#cb116-169" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Channel</span><span class="op">.</span><span class="fu">fromPath</span><span class="op">(</span> params<span class="op">.</span>polar_apolar_table <span class="op">).</span><span class="fu">set</span><span class="op">{</span> polar_apolar_table_ch <span class="op">}</span></span>
<span id="cb116-170"><a href="#cb116-170" aria-hidden="true" tabindex="-1"></a>    count_aa<span class="op">.</span>out<span class="op">.</span><span class="fu">combine</span><span class="op">(</span> polar_apolar_table_ch <span class="op">).</span><span class="fu">set</span><span class="op">{</span> count_by_polarity_in_ch <span class="op">}</span></span>
<span id="cb116-171"><a href="#cb116-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-172"><a href="#cb116-172" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count_by_polarity</span><span class="op">(</span> count_by_polarity_in_ch <span class="op">)</span></span>
<span id="cb116-173"><a href="#cb116-173" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aggregate_results</span><span class="op">(</span> count_by_polarity<span class="op">.</span>out<span class="op">.</span><span class="fu">map</span><span class="op">{</span> it<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">}.</span><span class="fu">collect</span><span class="op">()</span> <span class="op">)</span></span>
<span id="cb116-174"><a href="#cb116-174" aria-hidden="true" tabindex="-1"></a>    <span class="fu">make_plot</span><span class="op">(</span> aggregate_results<span class="op">.</span>out <span class="op">)</span></span>
<span id="cb116-175"><a href="#cb116-175" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</details>
<details>
<summary>
Click here to see the solution (<code>nextflow.config</code> file)
</summary>
<div class="sourceCode" id="cb117"><pre class="sourceCode groovy"><code class="sourceCode groovy"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co">// you can also put comments in nextflow.config</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>workDir <span class="op">=</span> <span class="st">&quot;../nextflow_workdir&quot;</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>withLabel<span class="op">:</span>r_tidyverse <span class="op">{</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>    conda <span class="op">=</span> <span class="st">&quot;r tidyverse&quot;</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>params <span class="op">{</span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>  samplesheet <span class="op">=</span> <span class="st">&quot;../nextflow_inputs/samplesheet.csv&quot;</span></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>  polar_apolar_table <span class="op">=</span> <span class="st">&quot;../nextflow_inputs/polar_apolar_table.csv&quot;</span></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</details>
<!--chapter:end:03-advanced.Rmd-->
</div>
</div>
<div id="additional-resources" class="section level1 unnumbered hasAnchor">
<h1 class="unnumbered hasAnchor">Additional resources<a href="#additional-resources" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Nextflow documentation:</p>
<p><a href="https://www.nextflow.io/docs/latest/index.html" class="uri">https://www.nextflow.io/docs/latest/index.html</a></p>
<p>Nextflow workshop from the Nextflow authors:</p>
<p><a href="https://www.nextflow.io/blog/2022/learn-nextflow-in-2022.html" class="uri">https://www.nextflow.io/blog/2022/learn-nextflow-in-2022.html</a></p>
<p>YouTube playlist:</p>
<p><a href="https://www.youtube.com/playlist?list=PLPZ8WHdZGxmUv4W8ZRlmstkZwhb_fencI" class="uri">https://www.youtube.com/playlist?list=PLPZ8WHdZGxmUv4W8ZRlmstkZwhb_fencI</a></p>
<p>Post on Medium on Nextflow from 23andMe:</p>
<p><a href="https://medium.com/23andme-engineering/introduction-to-nextflow-4d0e3b6768d1" class="uri">https://medium.com/23andme-engineering/introduction-to-nextflow-4d0e3b6768d1</a></p>
<p>Nextflow course on SofwareCarpentries:</p>
<p><a href="https://carpentries-incubator.github.io/workflows-nextflow/index.html" class="uri">https://carpentries-incubator.github.io/workflows-nextflow/index.html</a></p>
<p>The story of Nextflow from its author:</p>
<p><a href="https://elifesciences.org/labs/d193babe/the-story-of-nextflow-building-a-modern-pipeline-orchestrator" class="uri">https://elifesciences.org/labs/d193babe/the-story-of-nextflow-building-a-modern-pipeline-orchestrator</a></p>
<p>Paper comparing Nextflow to Snakemake and other workflow managers:</p>
<p><a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1008622" class="uri">https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1008622</a></p>
<p>Other useful links:</p>
<p><a href="https://www.nextflow.io/blog/2019/demystifying-nextflow-resume.html" class="uri">https://www.nextflow.io/blog/2019/demystifying-nextflow-resume.html</a></p>
</div>
<div id="credits" class="section level1 unnumbered hasAnchor">
<h1 class="unnumbered hasAnchor">Credits<a href="#credits" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The Favicon for this website is a derivative work of <a href="https://bioicons.com/icons/cc-by-sa-3.0/Chemo-_and_Bioinformatics/Guillaume_Paumier/DNA_microarray.svg">DNA_microarray icon</a> by <a href="https://guillaumepaumier.com/bio/">Guillaume Paumier</a>, which is licensed under <a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY SA 3.0</a></p>
<!--chapter:end:90-conclusion.Rmd-->
</div>
<!--bookdown:body:end-->
            </section>

          </div>
        </div>
      </div>
<!--bookdown:link_prev-->
<!--bookdown:link_next-->
    </div>
  </div>
<!--bookdown:config-->

</body>

</html>
